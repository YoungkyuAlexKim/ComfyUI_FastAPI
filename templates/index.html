<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI FastAPI - AI ì´ë¯¸ì§€ ìƒì„±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/css/styles.css?v=20240918_04" rel="stylesheet">
    <style>
        .size-input-group { display: flex; gap: 1rem; align-items: center; }
        .size-input-group .form-group { flex: 1; }
        .size-input-group .form-input { min-height: auto; padding: 0.75rem 1rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title"><i class="fas fa-palette"></i> ComfyUI AI ìƒì„±ê¸°</h1>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="app-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3 class="sidebar-title"><i class="fas fa-cogs"></i> ì›Œí¬í”Œë¡œìš°</h3>
                    <p class="sidebar-subtitle">ì‚¬ìš©í•  ì›Œí¬í”Œë¡œìš°ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                </div>
                <div class="workflow-list" id="workflow-list"></div>
                <div class="sidebar-footer">
                    <div class="current-workflow" id="current-workflow">
                        <small class="workflow-info">
                            <i class="fas fa-info-circle"></i> ì„ íƒëœ ì›Œí¬í”Œë¡œìš°: <span id="selected-workflow-name">ì—†ìŒ</span>
                        </small>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Input Panel -->
                <div class="input-panel">
                    <div class="input-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-magic"></i> AI ì´ë¯¸ì§€ ìƒì„±</h2>
                            <p class="card-subtitle">ComfyUIë¥¼ í™œìš©í•œ ê³ í’ˆì§ˆ ì´ë¯¸ì§€ ìƒì„±</p>
                        </div>
                        <div class="card-content">
                            <div class="form-grid">
                                <!-- ê¸ì • í”„ë¡¬í”„íŠ¸ -->
                                <div class="form-group">
                                    <label class="form-label" for="prompt"><i class="fas fa-check-circle"></i> ê¸ì • í”„ë¡¬í”„íŠ¸</label>
                                    <textarea class="form-input" id="prompt" placeholder="ì˜ˆ: 1girl, pixel art..." rows="6">{{ default_prompt }}</textarea>
                                    <button class="translate-btn" data-target="prompt"><i class="fas fa-language"></i> Danbooru íƒœê·¸ë¡œ ë³€í™˜</button>
                                </div>
                                <!-- ë¶€ì • í”„ë¡¬í”„íŠ¸ -->
                                <div class="form-group">
                                    <label class="form-label" for="negative_prompt"><i class="fas fa-ban"></i> ë¶€ì • í”„ë¡¬í”„íŠ¸</label>
                                    <textarea class="form-input" id="negative_prompt" placeholder="ì˜ˆ: blurry, ugly..." rows="3">{{ default_negative_prompt }}</textarea>
                                </div>
                                <!-- ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ì…ë ¥ -->
                                <div class="size-input-group">
                                    <div class="form-group">
                                        <label class="form-label" for="width"><i class="fas fa-arrows-alt-h"></i> ê°€ë¡œ</label>
                                        <input type="number" class="form-input" id="width" value="{{ default_width }}" min="64" step="8">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="height"><i class="fas fa-arrows-alt-v"></i> ì„¸ë¡œ</label>
                                        <input type="number" class="form-input" id="height" value="{{ default_height }}" min="64" step="8">
                                    </div>
                                </div>
                            </div>
                            <button class="generate-btn" id="generate-btn">
                                <i class="fas fa-sparkles"></i> <span>ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</span>
                            </button>
                            <div class="progress-section" id="progress-section" style="display: none;">
                                <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                                <div class="progress-text" id="progress-text">0%</div>
                            </div>
                            <div class="status-container" id="status-container" style="display: none;"><p id="status-message"></p></div>
                        </div>
                    </div>
                </div>
                <!-- Output Panel -->
                <div class="output-panel">
                    <div class="seed-section">
                        <div class="seed-input-group">
                            <label class="seed-label" for="seed"><i class="fas fa-dice"></i> ì‹œë“œê°’</label>
                            <input type="number" class="seed-input" id="seed" placeholder="ëœë¤" min="0">
                            <small class="seed-hint">ë™ì¼ ì´ë¯¸ì§€ ì¬ìƒì„±ìš©</small>
                        </div>
                    </div>
                    <div class="output-card">
                        <div class="placeholder-section" id="placeholder-section">
                             <div class="placeholder-card">
                                <h3 class="placeholder-title"><i class="fas fa-magic"></i> AI ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼</h3>
                                <div class="placeholder-container">
                                    <div class="placeholder-icon"><i class="fas fa-image"></i></div>
                                    <p class="placeholder-text">í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ê³  "ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬<br>AIê°€ ë§Œë“  ë†€ë¼ìš´ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
                                </div>
                            </div>
                        </div>
                        <div class="result-section" id="result-section" style="display: none;">
                             <div class="result-card">
                                <h3 class="result-title"><i class="fas fa-image"></i> ìƒì„±ëœ ì´ë¯¸ì§€</h3>
                                <div class="image-container">
                                    <img id="result-image" src="" alt="ìƒì„±ëœ ì´ë¯¸ì§€ ê²°ê³¼" class="result-image">
                                </div>
                                <p class="result-hint">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        let currentWorkflow = null;
        const ui = {
            workflowList: document.getElementById('workflow-list'),
            selectedWorkflowName: document.getElementById('selected-workflow-name'),
            generateBtn: document.getElementById('generate-btn'),
            promptInput: document.getElementById('prompt'),
            negativePromptInput: document.getElementById('negative_prompt'),
            widthInput: document.getElementById('width'),
            heightInput: document.getElementById('height'),
            seedInput: document.getElementById('seed'),
            progressSection: document.getElementById('progress-section'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            statusContainer: document.getElementById('status-container'),
            statusMessage: document.getElementById('status-message'),
            placeholderSection: document.getElementById('placeholder-section'),
            resultSection: document.getElementById('result-section'),
            resultImage: document.getElementById('result-image'),
        };

        const ws = new WebSocket(`ws://${window.location.host}/ws/status`);
        ws.onopen = () => console.log("âœ… WebSocket connected");
        ws.onmessage = handleWebSocketMessage;
        ui.generateBtn.addEventListener('click', handleGenerateClick);

        async function loadWorkflows() {
            try {
                const response = await fetch('/api/v1/workflows');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.workflows && data.workflows.length > 0) {
                    renderWorkflows(data.workflows);
                    selectWorkflow(data.workflows[0]);
                } else {
                    ui.workflowList.innerHTML = `<div class="workflow-error">ì›Œí¬í”Œë¡œìš°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
            } catch (error) {
                console.error('Workflow load error:', error);
            }
        }

        function renderWorkflows(workflows) {
            ui.workflowList.innerHTML = workflows.map(wf => `
                <div class="workflow-item" data-workflow-id="${wf.id}">
                    <div class="workflow-item-header">
                        <div class="workflow-icon"><i class="fas fa-project-diagram"></i></div>
                        <div class="workflow-item-info">
                            <div class="workflow-name">${wf.name}</div>
                            <div class="workflow-description">${wf.description}</div>
                        </div>
                    </div>
                </div>`).join('');
            ui.workflowList.querySelectorAll('.workflow-item').forEach((item, i) => item.addEventListener('click', () => selectWorkflow(workflows[i])));
        }

        function selectWorkflow(workflow) {
            currentWorkflow = workflow;
            document.querySelectorAll('.workflow-item').forEach(item => item.classList.toggle('selected', item.dataset.workflowId === workflow.id));
            ui.selectedWorkflowName.textContent = workflow.name;
        }

        function handleWebSocketMessage(event) {
            const data = JSON.parse(event.data);
            if (data.progress !== undefined) updateProgress(data.progress);
            if (data.status === 'running') setGenerateButtonState(true, 'AI ìƒì„± ì¤‘...');
            if (data.status === 'complete') {
                showStatus('ğŸ‰ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!', 'success');
                setGenerateButtonState(false, 'ìƒˆ ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                if (data.image_path) displayImage(data.image_path);
            }
            if (data.error) {
                showStatus(`âŒ ì˜¤ë¥˜: ${data.error}`, 'error');
                setGenerateButtonState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
            }
        }

        async function handleGenerateClick() {
            if (!currentWorkflow) return showStatus('ì›Œí¬í”Œë¡œìš°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            if (!ui.promptInput.value.trim()) return showStatus('ê¸ì • í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');

            const width = parseInt(ui.widthInput.value, 10);
            const height = parseInt(ui.heightInput.value, 10);

            if (isNaN(width) || width <= 0) return showStatus('ìœ íš¨í•œ ê°€ë¡œ(width) í¬ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            if (isNaN(height) || height <= 0) return showStatus('ìœ íš¨í•œ ì„¸ë¡œ(height) í¬ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');

            setGenerateButtonState(true, 'ìš”ì²­ ì²˜ë¦¬ ì¤‘...');
            showStatus('ì„œë²„ì— ìƒì„± ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤...', 'info');

            const requestData = {
                prompt: ui.promptInput.value.trim(),
                negative_prompt: ui.negativePromptInput.value.trim(),
                width: width,
                height: height,
                workflow_id: currentWorkflow.id,
                seed: ui.seedInput.value ? parseInt(ui.seedInput.value, 10) : null
            };

            try {
                const response = await fetch('/api/v1/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Unknown error');
                showStatus(result.message, 'info');
            } catch (error) {
                showStatus(`âŒ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'error');
                setGenerateButtonState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
            }
        }

        function setGenerateButtonState(isLoading, text) {
            ui.generateBtn.disabled = isLoading;
            ui.generateBtn.innerHTML = isLoading ? `<div class="loading-spinner"></div><span>${text}</span>` : `<i class="fas fa-sparkles"></i><span>${text}</span>`;
        }

        function showStatus(message, type = 'info') {
            ui.statusMessage.textContent = message;
            ui.statusContainer.className = `status-container status-${type}`;
            ui.statusContainer.style.display = 'block';
        }

        function updateProgress(percent) {
            ui.progressSection.style.display = 'block';
            ui.progressBar.style.width = `${percent}%`;
            ui.progressText.textContent = `${Math.round(percent)}%`;
        }

        function displayImage(imagePath) {
            ui.resultImage.src = `${imagePath}?t=${new Date().getTime()}`;
            ui.resultImage.onload = () => {
                ui.placeholderSection.style.display = 'none';
                ui.resultSection.style.display = 'block';
            };
        }

        document.querySelectorAll('textarea.form-input').forEach(t => t.addEventListener('input', () => { t.style.height = 'auto'; t.style.height = `${t.scrollHeight}px`; }));
        loadWorkflows();
    });
    </script>
    <script src="/static/js/prompt_translate.js"></script>
</body>
</html>

