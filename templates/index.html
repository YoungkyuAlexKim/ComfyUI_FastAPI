<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI FastAPI - AI ì´ë¯¸ì§€ ìƒì„±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/css/styles.css?v=20250919_02" rel="stylesheet">
</head>
<body>
    <div class="app-container" data-anon-id="{{ anon_id }}">
        <div class="app-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h1 class="app-title"><i class="fas fa-palette"></i> ComfyUI AI ìƒì„±ê¸°</h1>
                </div>
                <div class="workflow-section">
                    <div class="workflow-section-header">
                        <h3 class="sidebar-title"><i class="fas fa-cogs"></i> ì›Œí¬í”Œë¡œìš°</h3>
                    </div>
                    <div class="workflow-list" id="workflow-list"></div>
                </div>
                <div class="sidebar-footer">
                    <div class="current-workflow" id="current-workflow">
                        <small class="workflow-info">
                            <i class="fas fa-info-circle"></i> ì„ íƒëœ ì›Œí¬í”Œë¡œìš°: <span id="selected-workflow-name">ì—†ìŒ</span>
                        </small>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div class="input-panel">
                    <div class="input-card">
                        <div class="card-header">
                            <div class="workflow-info-header">
                                <h2 class="workflow-name-display" id="workflow-name-display">ì›Œí¬í”Œë¡œìš°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
                                <p class="workflow-description-display" id="workflow-description-display">ì™¼ìª½ì—ì„œ ì‚¬ìš©í•  ì›Œí¬í”Œë¡œìš°ë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="user_prompt"><i class="fas fa-comment-dots"></i> í”„ë¡¬í”„íŠ¸ (ë‚´ìš©)</label>
                                    <p class="prompt-suggestion" id="prompt-suggestion-text" style="display: none;"></p>
                                    <div class="input-with-action">
                                        <textarea class="form-input" id="user_prompt" placeholder="ê·¸ë¦¬ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í•œë³µì„ ì…ì€ ì†Œë…€)..." rows="5">{{ default_user_prompt }}</textarea>
                                        <button class="translate-btn translate-btn--icon" data-target="user_prompt" data-tooltip="Danbooru íƒœê·¸ë¡œ ë³€í™˜" aria-label="Danbooru íƒœê·¸ë¡œ ë³€í™˜">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="style_prompt"><i class="fas fa-palette"></i> ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ìŠ¤íƒ€ì¼ & í’ˆì§ˆ)</label>
                                    <textarea class="form-input" id="style_prompt" rows="2" readonly>{{ default_style_prompt }}</textarea>
                                </div>
                                <div class="form-group" id="negative-prompt-wrap">
                                    <label class="form-label" for="negative_prompt"><i class="fas fa-ban"></i> ì‹œìŠ¤í…œ ë¶€ì • í”„ë¡¬í”„íŠ¸</label>
                                    <textarea class="form-input" id="negative_prompt" rows="2" readonly>{{ default_negative_prompt }}</textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label"><i class="fas fa-crop-alt"></i> ì´ë¯¸ì§€ ë¹„ìœ¨</label>
                                    <div class="aspect-ratio-group" id="aspect-ratio-group">
                                        <button class="aspect-ratio-btn selected" data-ratio="square">
                                            <i class="icon fas fa-square"></i>
                                            <span class="label">Square</span>
                                        </button>
                                        <button class="aspect-ratio-btn" data-ratio="landscape">
                                            <i class="icon fas fa-window-maximize"></i>
                                            <span class="label">Landscape</span>
                                        </button>
                                        <button class="aspect-ratio-btn" data-ratio="portrait">
                                            <i class="icon fas fa-mobile-screen-button"></i>
                                            <span class="label">Portrait</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="status-container" id="status-container"><p id="status-message"></p></div>
                        </div>
                    </div>
                </div>
                <div class="output-panel">
                    <div class="control-section">
                        <div class="seed-section">
                        <div class="seed-input-group">
                            <div class="seed-input-wrapper">
                                <label class="seed-label" for="seed"><i class="fas fa-dice"></i> ì‹œë“œê°’</label>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="number" class="seed-input" id="seed" placeholder="ëœë¤" min="0">
                                    <button id="seed-random-btn" type="button" title="ëœë¤ ì‹œë“œ" style="border:1px solid var(--neutral-300); background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;">
                                        <i class="fas fa-dice"></i><span style="font-size:12px;">ëœë¤</span>
                                    </button>
                                </div>
                                <small class="seed-hint">ë™ì¼ ì´ë¯¸ì§€ ì¬ìƒì„±ìš©</small>
                            </div>
                        </div>
                        </div>
                    </div>
                    <!-- ë¡œë”©ë°”ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ë¶„ë¦¬ -->
                    <div class="progress-section" id="progress-section">
                        <h3 class="progress-title"><i class="fas fa-clock"></i> ìƒì„± ì§„í–‰ë¥ </h3>
                        <div class="progress-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <div class="progress-text" id="progress-text">0%</div>
                        <div class="progress-right-label" id="progress-right" style="display:none;">0%</div>
                        <div class="queue-info" id="queue-info" style="display:none; margin-top:6px; font-size: 13px; color: var(--neutral-600); display:flex; gap:8px; align-items:center;">
                            <span class="badge" id="queue-position" style="background: var(--neutral-100); border:1px solid var(--neutral-200); border-radius: 9999px; padding: 2px 8px; font-weight:600; color: var(--neutral-700);"></span>
                            <span id="queue-eta" style="color: var(--neutral-500);"></span>
                        </div>
                    </div>
                    
                        <div class="output-card" style="position:relative;">
                            <div class="output-toolbar">
                                <button class="generate-btn" id="generate-btn">
                                <i class="fas fa-sparkles"></i> <span>ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</span>
                            </button>
                            <button class="cancel-btn" id="cancel-btn" disabled>
                                <i class="fas fa-stop-circle"></i> <span>ìƒì„± ì·¨ì†Œ</span>
                            </button>
                                
                                <div class="output-tools" style="margin-left:auto; display:flex; align-items:center; gap:8px;">
                                    <label style="display:inline-flex; align-items:center; gap:6px; font-size:13px; border:1px solid var(--neutral-300); padding:6px 10px; border-radius:8px; background:#fff;">
                                        <input type="checkbox" id="control-enabled" />
                                        <span>ControlNet ì‚¬ìš©</span>
                                    </label>
                                    <button id="open-canvas-btn" type="button" class="chip-btn" title="ìº”ë²„ìŠ¤ ì—´ê¸°" aria-label="ìº”ë²„ìŠ¤ ì—´ê¸°"><i class="fas fa-pencil"></i> ìº”ë²„ìŠ¤ ì—´ê¸°</button>
                                    <button id="open-btn" type="button" class="icon-btn" title="ìƒˆ íƒ­ì—ì„œ ì—´ê¸°" aria-label="ìƒˆ íƒ­ì—ì„œ ì—´ê¸°">
                                        <i class="fas fa-up-right-from-square" aria-hidden="true"></i>
                                    </button>
                                    <button id="download-btn" type="button" class="icon-btn" title="ë‹¤ìš´ë¡œë“œ" aria-label="ë‹¤ìš´ë¡œë“œ">
                                        <i class="fas fa-download" aria-hidden="true"></i>
                                    </button>
                                    <button id="copylink-btn" type="button" class="icon-btn" title="ë§í¬ ë³µì‚¬" aria-label="ë§í¬ ë³µì‚¬">
                                        <i class="fas fa-link" aria-hidden="true"></i>
                                    </button>
                                </div>
                        </div>
                        <div class="placeholder-section" id="placeholder-section">
                             <div class="placeholder-card">
                                <h3 class="placeholder-title"><i class="fas fa-magic"></i> AI ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼</h3>
                                <div class="placeholder-container">
                                    <div class="placeholder-icon"><i class="fas fa-image"></i></div>
                                    <p class="placeholder-text">ê·¸ë¦¬ê³  ì‹¶ì€ ë‚´ìš©ì„ í”„ë¡¬í”„íŠ¸ì— ì…ë ¥í•˜ê³ <br>"ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
                                </div>
                            </div>
                            <!-- Floating control thumb independent of result/placeholder sections -->
                            <div id="control-floating" style="position:absolute; top:115px; right:8px; width:52px; height:52px; border-radius:12px; border:1px solid var(--neutral-300); background: rgba(255,255,255,0.92); box-shadow: var(--shadow-lg); backdrop-filter: saturate(120%) blur(4px); overflow:hidden; display:none; z-index:9999; display:flex; align-items:center; justify-content:center;">
                                <img id="control-floating-img" alt="ì„ íƒëœ ì»¨íŠ¸ë¡¤" style="width:100%; height:100%; object-fit:cover; display:none;" />
                            </div>
                        </div>
                        <div class="result-section" id="result-section" style="display: none;">
                             <div class="result-card">
                                <div class="result-content">
                                    <h3 class="result-title"><i class="fas fa-image"></i> ìƒì„±ëœ ì´ë¯¸ì§€</h3>
                                    <div class="image-container" id="result-image-container" style="position:relative;">
                                        <img id="result-image" src="" alt="ìƒì„±ëœ ì´ë¯¸ì§€ ê²°ê³¼" class="result-image" style="display:none;">
                                    </div>
                                    <p class="result-hint" id="result-hint">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                        <div class="preview-overlay" id="preview-overlay" aria-live="polite" aria-atomic="true">
                            <div class="preview-overlay-content">
                                <div class="loading-spinner" style="margin: 0 auto var(--space-sm);"></div>
                                <div class="preview-overlay-tip typing-caret" id="preview-tip"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="gallery-panel">
                    <div class="gallery-section" id="gallery-section" data-skeleton-count="12">
                        <div class="gallery-card">
                            <div class="gallery-header" style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap: nowrap;">
                                <div class="gallery-tabs" style="display:flex; gap:8px; flex-wrap: nowrap;">
                                    <button id="tab-generated" type="button" class="chip-btn active"><i class="fas fa-images"></i> ìƒì„± ì´ë¯¸ì§€</button>
                                    <button id="tab-controls" type="button" class="chip-btn"><i class="fas fa-pen-ruler"></i> ë‚´ ì»¨íŠ¸ë¡¤</button>
                                </div>
                                <div style="flex:1"></div>
                            </div>
                            <div class="gallery-title-row" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <h3 class="gallery-title" id="gallery-title" style="margin:0;"><i class="fas fa-clock-rotate-left"></i> ìµœê·¼ ìƒì„± ì´ë¯¸ì§€</h3>
                                <div class="gallery-actions-right" style="display:flex; align-items:center; gap:6px;">
                                    <button id="control-upload-icon" type="button" class="icon-btn" title="ì»¨íŠ¸ë¡¤ ì—…ë¡œë“œ" aria-label="ì»¨íŠ¸ë¡¤ ì—…ë¡œë“œ" style="display:none;"><i class="fas fa-upload"></i></button>
                                    <input id="control-upload" type="file" accept="image/png,image/jpeg,image/webp" style="display:none;" />
                                </div>
                            </div>
                            <div class="gallery-actions" id="gallery-actions">
                                <button class="chip-btn chip-btn--ghost icon-only" id="select-toggle-btn" type="button" aria-label="ì„ íƒ" title="ì„ íƒ">
                                    <i class="fas fa-list-check"></i>
                                </button>
                                <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
                                    <span id="selected-count" style="font-size:12px; color: var(--neutral-600); display:none;">0ê°œ ì„ íƒë¨</span>
                                    <button class="chip-btn icon-only" id="select-all-btn" type="button" style="display:none;" aria-label="ëª¨ë‘ì„ íƒ" title="ëª¨ë‘ì„ íƒ"><i class="fas fa-check-double"></i></button>
                                    <button class="chip-btn chip-btn--ghost icon-only" id="clear-selection-btn" type="button" style="display:none;" aria-label="ì„ íƒí•´ì œ" title="ì„ íƒí•´ì œ"><i class="fas fa-circle-xmark"></i></button>
                                    <button class="chip-btn chip-btn--danger icon-only" id="delete-selected-btn" type="button" style="display:none;" aria-label="ì„ íƒ ì‚­ì œ" title="ì„ íƒ ì‚­ì œ" disabled><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="gallery-grid" id="gallery-grid"></div>
                            <button class="gallery-load-more" id="gallery-load-more" style="display:none;">
                                <i class="fas fa-chevron-down"></i> ë” ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script id="workflows-sizes-data" type="application/json">{{ workflows_sizes_json | safe }}</script>
    <script id="workflow-default-prompts-data" type="application/json">{{ workflow_default_prompts_json | safe }}</script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        let currentWorkflow = null;
        let selectedAspectRatio = (function(){ try { return localStorage.getItem('selectedAspectRatio') || 'square'; } catch (_) { return 'square'; } })();
        const workflowsSizes = JSON.parse(document.getElementById('workflows-sizes-data').textContent);
        const workflowDefaultPrompts = JSON.parse(document.getElementById('workflow-default-prompts-data').textContent);

        const ui = {
            workflowList: document.getElementById('workflow-list'),
            selectedWorkflowName: document.getElementById('selected-workflow-name'),
            workflowNameDisplay: document.getElementById('workflow-name-display'),
            workflowDescriptionDisplay: document.getElementById('workflow-description-display'),
            generateBtn: document.getElementById('generate-btn'),
            userPromptInput: document.getElementById('user_prompt'),
            stylePromptInput: document.getElementById('style_prompt'),
            negativePromptInput: document.getElementById('negative_prompt'),
            promptSuggestionText: document.getElementById('prompt-suggestion-text'),
            aspectRatioGroup: document.getElementById('aspect-ratio-group'),
            seedInput: document.getElementById('seed'),
            progressSection: document.getElementById('progress-section'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressBubble: document.getElementById('progress-bubble'),
            progressRight: document.getElementById('progress-right'),
            statusContainer: document.getElementById('status-container'),
            statusMessage: document.getElementById('status-message'),
            placeholderSection: document.getElementById('placeholder-section'),
            resultSection: document.getElementById('result-section'),
            resultImage: document.getElementById('result-image'),
        };

        const anonId = document.querySelector('.app-container')?.getAttribute('data-anon-id') || '';
        const wsProto = window.location.protocol === 'https:' ? 'wss' : 'ws';
        let ws = null;
        let wsRetry = 0;
        function connectWS(){
            try {
                ws = new WebSocket(`${wsProto}://${window.location.host}/ws/status?anon_id=${encodeURIComponent(anonId)}`);
                ws.onopen = () => { console.log('âœ… WebSocket connected'); wsRetry = 0; };
                ws.onmessage = handleWebSocketMessage;
                ws.onclose = () => {
                    // Exponential backoff up to ~10s
                    const delay = Math.min(10000, 500 * Math.pow(2, wsRetry++));
                    setTimeout(connectWS, delay);
                };
                ws.onerror = () => {
                    try { ws.close(); } catch(_) {}
                };
            } catch (e) {
                const delay = Math.min(10000, 500 * Math.pow(2, wsRetry++));
                setTimeout(connectWS, delay);
            }
        }
        connectWS();
        // Reflect saved aspect-ratio selection on initial UI
        try {
            document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.ratio === selectedAspectRatio);
            });
        } catch(_) {}

        ui.generateBtn.addEventListener('click', handleGenerateClick);
        // ë¶€ì • í”„ë¡¬í”„íŠ¸ ì˜ì—­ í‘œì‹œ ì—¬ë¶€ ì„¤ì •ê°’ ë°˜ì˜
        try {
            const showNeg = !!(window.APP_CONFIG && window.APP_CONFIG.ui && window.APP_CONFIG.ui.showNegativePrompt);
            const negWrap = document.getElementById('negative-prompt-wrap');
            if (negWrap) negWrap.style.display = showNeg ? '' : 'none';
        } catch (_) {}
        const cancelBtn = document.getElementById('cancel-btn');
        cancelBtn.addEventListener('click', handleCancelClick);
        ui.promptSuggestionText.addEventListener('click', handleSuggestionClick);
        const seedRandomBtn = document.getElementById('seed-random-btn');
        if (seedRandomBtn) seedRandomBtn.addEventListener('click', () => {
            const v = Math.floor(Math.random() * 1e12);
            ui.seedInput.value = String(v);
            try { localStorage.setItem('lastSeed', String(v)); } catch(_) {}
        });
        ui.seedInput.addEventListener('change', () => { try { localStorage.setItem('lastSeed', ui.seedInput.value || ''); } catch(_) {} });
        (function(){ try { const last = localStorage.getItem('lastSeed'); if (last) ui.seedInput.value = last; } catch(_) {} })();

        // Result actions
        const openBtn = document.getElementById('open-btn');
        const downloadBtn = document.getElementById('download-btn');
        const copyLinkBtn = document.getElementById('copylink-btn');
        let lastImageUrlOriginal = '';
        function setResultActionsEnabled(enabled){
            [openBtn, downloadBtn, copyLinkBtn].forEach((b)=>{ if (b) b.disabled = !enabled; });
        }
        setResultActionsEnabled(false);
        if (openBtn) openBtn.addEventListener('click', async () => { if (!lastImageUrlOriginal) return; const ok = await headOk(lastImageUrlOriginal); if (ok) window.open(lastImageUrlOriginal, '_blank'); else showStatus('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error'); });
        if (downloadBtn) downloadBtn.addEventListener('click', async () => {
            if (!lastImageUrlOriginal) return;
            const ok = await headOk(lastImageUrlOriginal);
            if (!ok) { showStatus('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error'); return; }
            const a = document.createElement('a');
            a.href = lastImageUrlOriginal;
            a.download = (lastImageUrlOriginal.split('/').pop() || 'image.png');
            document.body.appendChild(a);
            a.click();
            a.remove();
        });
        if (copyLinkBtn) copyLinkBtn.addEventListener('click', async () => {
            if (!lastImageUrlOriginal) return;
            const ok = await headOk(lastImageUrlOriginal);
            if (!ok) { showStatus('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error'); return; }
            try { await navigator.clipboard.writeText(new URL(lastImageUrlOriginal, window.location.origin).toString()); showStatus('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info'); } catch(_) { showStatus('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨', 'error'); }
        });

        // Track the latest job started by this client
        let currentJobId = null;
        let queueTimer = null;
        async function headOk(url){
            try {
                const res = await fetch(url, { method:'HEAD', cache:'no-store' });
                return res.ok;
            } catch (_) { return false; }
        }

        ui.aspectRatioGroup.addEventListener('click', (e) => {
            const button = e.target.closest('.aspect-ratio-btn');
            if (button) {
                selectedAspectRatio = button.dataset.ratio;
                document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn === button);
                });
                try { localStorage.setItem('selectedAspectRatio', selectedAspectRatio); } catch(_) {}
            }
        });

        async function loadWorkflows() {
            try {
                const response = await fetch('/api/v1/workflows');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.workflows && data.workflows.length > 0) {
                    renderWorkflows(data.workflows);
                    let storedId = null;
                    try { storedId = localStorage.getItem('selectedWorkflowId') || null; } catch(_) {}
                    const found = storedId ? data.workflows.find(w => w.id === storedId) : null;
                    selectWorkflow(found || data.workflows[0]);
                } else {
                    ui.workflowList.innerHTML = `<div class="workflow-error">ì›Œí¬í”Œë¡œìš°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
            } catch (error) {
                console.error('Workflow load error:', error);
            }
        }

        function renderWorkflows(workflows) {
            ui.workflowList.innerHTML = workflows.map(wf => `
                <div class="workflow-item" data-workflow-id="${wf.id}">
                    <div class="workflow-item-header">
                        <div class="workflow-icon"><i class="fas fa-project-diagram"></i></div>
                        <div class="workflow-item-info">
                            <div class="workflow-name">${wf.name}</div>
                            <div class="workflow-description">${wf.description}</div>
                        </div>
                    </div>
                </div>`).join('');
            
            ui.workflowList.querySelectorAll('.workflow-item').forEach((item, i) => {
                item.addEventListener('click', () => selectWorkflow(workflows[i]));
            });
        }
        
        function selectWorkflow(workflow) {
            currentWorkflow = workflow;
            
            document.querySelectorAll('.workflow-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.workflowId === workflow.id);
            });
            ui.selectedWorkflowName.textContent = workflow.name;
            try { localStorage.setItem('selectedWorkflowId', workflow.id); } catch(_) {}

            // ë©”ì¸ í—¤ë” ì—…ë°ì´íŠ¸
            ui.workflowNameDisplay.textContent = workflow.name;
            ui.workflowNameDisplay.classList.add('selected');
            ui.workflowDescriptionDisplay.textContent = workflow.description || 'ì„ íƒëœ ì›Œí¬í”Œë¡œìš°ë¡œ ê³ í’ˆì§ˆ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”';

            // ì›Œí¬í”Œë¡œìš°ë³„ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •
            const defaultPrompt = workflowDefaultPrompts[workflow.id] || '';
            ui.userPromptInput.value = defaultPrompt;
            autoResizeTextarea(ui.userPromptInput);

            ui.stylePromptInput.value = workflow.style_prompt;
            ui.negativePromptInput.value = workflow.negative_prompt;
            
            if (workflow.recommended_prompt) {
                ui.promptSuggestionText.innerHTML = `âœ¨ ì¶”ì²œ: <span class="suggestion-tags">${workflow.recommended_prompt}</span> (í´ë¦­í•˜ì—¬ ì¶”ê°€)`;
                ui.promptSuggestionText.style.display = 'block';
            } else {
                ui.promptSuggestionText.style.display = 'none';
            }
        }

        function handleSuggestionClick() {
            if (!currentWorkflow || !currentWorkflow.recommended_prompt) return;
            const cleanTags = (str) => str.split(',').map(tag => tag.trim()).filter(Boolean);
            const existingTags = new Set(cleanTags(ui.userPromptInput.value.toLowerCase()));
            const recommendedTags = cleanTags(currentWorkflow.recommended_prompt);
            const newTags = recommendedTags.filter(tag => !existingTags.has(tag.toLowerCase()));
            if (newTags.length > 0) {
                const newTagsString = newTags.join(', ');
                const currentPrompt = ui.userPromptInput.value.trim();
                ui.userPromptInput.value = currentPrompt ? newTagsString + ', ' + currentPrompt : newTagsString;
                autoResizeTextarea(ui.userPromptInput);
            }
        }

        function handleWebSocketMessage(event) {
            const data = JSON.parse(event.data);
            // Process only current job's events when job_id is present
            if (data.job_id) {
                if (!currentJobId) return; // no active job â†’ ignore job-scoped events
                if (data.job_id !== currentJobId) return;
            }
            if (data.status === 'queued') {
                // Show queued info (position if present)
                const pos = (typeof data.position === 'number') ? data.position + 1 : null;
                const msg = pos ? `ëŒ€ê¸°ì¤‘... (${pos}ë²ˆì§¸)` : 'ëŒ€ê¸°ì¤‘...';
                showStatus(msg, 'info');
                setGenerationState(true, 'ëŒ€ê¸°ì¤‘...');
                updateProgress(0);
                if (pos) showQueueInfo(pos); else showQueueInfo();
                return;
            }
            if (typeof data.progress === 'number') updateProgress(data.progress);
            if (data.status === 'running') { setGenerationState(true, 'AI ìƒì„± ì¤‘...'); hideQueueInfo(); stopQueuePolling(); }
            if (data.status === 'complete') {
                showStatus('ğŸ‰ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!', 'success');
                updateProgress(0); // ì™„ë£Œ í›„ ì§„í–‰ë¥ ì„ 0%ë¡œ ë¦¬ì…‹
                if (data.image_path) {
                    displayImage(data.image_path, () => {
                        // ë¨¼ì € ì˜¤ë²„ë ˆì´ í˜ì´ë“œì•„ì›ƒ ì‹œì‘
                        hidePreviewOverlay();
                        // ë²„íŠ¼ ë³µêµ¬ëŠ” ì˜¤ë²„ë ˆì´ í˜ì´ë“œì•„ì›ƒì´ ëë‚œ ë’¤
                        const fadeMs = (window.APP_CONFIG && window.APP_CONFIG.loading && (window.APP_CONFIG.loading.overlayFadeOutMs || window.APP_CONFIG.loading.fadeMs)) || 300;
                        setTimeout(() => setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°'), Math.max(50, fadeMs));
                    });
                } else {
                    hidePreviewOverlay();
                    const fadeMs = (window.APP_CONFIG && window.APP_CONFIG.loading && (window.APP_CONFIG.loading.overlayFadeOutMs || window.APP_CONFIG.loading.fadeMs)) || 300;
                    setTimeout(() => setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°'), Math.max(50, fadeMs));
                }
                // Immediate safety unlock in case late events re-toggle state
                setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                currentJobId = null;
                // Final watchdog to ensure overlay/buttons reset
                setTimeout(() => { hidePreviewOverlay(); setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°'); }, 2500);
                hideQueueInfo();
                stopQueuePolling();
            }
            if (data.status === 'cancelling') {
                showStatus('â¸ï¸ ì·¨ì†Œ ìš”ì²­ ì „ì†¡ë¨...', 'info');
            }
            if (data.status === 'cancelled') {
                showStatus('ğŸ›‘ ì´ë¯¸ì§€ ìƒì„±ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.', 'error');
                updateProgress(0);
                // ì·¨ì†Œ ì‹œ: í˜„ì¬ ë³´ì´ëŠ” ì´ë¯¸ì§€/í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ìœ ì§€í•˜ê³ , ì˜¤ë²„ë ˆì´ëŠ” ì§§ê²Œ í˜ì´ë“œì•„ì›ƒ
                // ë²„íŠ¼ì€ ì¦‰ì‹œ ë³µêµ¬(ì·¨ì†Œ ì§í›„ ì¬ì‹œë„ ê°€ëŠ¥í•˜ê²Œ)
                hidePreviewOverlay();
                setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                currentJobId = null;
                setTimeout(() => { hidePreviewOverlay(); setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°'); }, 1500);
                hideQueueInfo();
                stopQueuePolling();
            }
            if (data.error) {
                showStatus(`âŒ ì˜¤ë¥˜: ${data.error}`, 'error');
                setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                updateProgress(0); // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì§„í–‰ë¥ ì„ 0%ë¡œ ë¦¬ì…‹
                hidePreviewOverlay();
                currentJobId = null;
                setTimeout(() => { hidePreviewOverlay(); setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°'); }, 1500);
                hideQueueInfo();
                stopQueuePolling();
            }
        }

        async function preflightHealthCheck(){
            const ac = new AbortController();
            const timer = setTimeout(() => { try { ac.abort(); } catch(_) {} }, 1500);
            try {
                const res = await fetch('/healthz', { cache: 'no-store', signal: ac.signal });
                if (!res.ok) return false;
                const data = await res.json();
                return !!(data && data.ok === true);
            } catch (_) {
                return false;
            } finally {
                clearTimeout(timer);
            }
        }

        async function handleGenerateClick() {
            if (!currentWorkflow) return showStatus('ì›Œí¬í”Œë¡œìš°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            if (!ui.userPromptInput.value.trim()) return showStatus('ê·¸ë¦¬ê³  ì‹¶ì€ ë‚´ìš©ì„ í”„ë¡¬í”„íŠ¸ì— ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');

            // Preflight health check (silent guard)
            try {
                const ok = await preflightHealthCheck();
                if (!ok) {
                    showStatus('ì§€ê¸ˆì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    try { document.getElementById('status-container')?.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(_) {}
                    try { alert('ì§€ê¸ˆì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); } catch(_) {}
                    return;
                }
            } catch (_) {
                showStatus('ì§€ê¸ˆì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                try { document.getElementById('status-container')?.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(_) {}
                try { alert('ì§€ê¸ˆì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); } catch(_) {}
                return;
            }

            setGenerationState(true, 'ìš”ì²­ ì²˜ë¦¬ ì¤‘...');
            showStatus('ì„œë²„ì— ìƒì„± ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤...', 'info');

            showPreviewOverlay();

            const requestData = {
                user_prompt: ui.userPromptInput.value.trim(),
                aspect_ratio: selectedAspectRatio,
                workflow_id: currentWorkflow.id,
                seed: ui.seedInput.value ? parseInt(ui.seedInput.value, 10) : null
            };

            // ControlNet options
            try {
                const enabled = !!document.getElementById('control-enabled')?.checked;
                const lastSelectedControlId = (function(){ try { return localStorage.getItem('selectedControlId') || ''; } catch(_) { return ''; } })();
                // ê°€ë“œ: ì»¨íŠ¸ë¡¤ë„· ì‚¬ìš© ì²´í¬ê°€ ì¼œì ¸ìˆëŠ”ë° ì„ íƒëœ ì»¨íŠ¸ë¡¤ì´ ì—†ìœ¼ë©´ ìš”ì²­ ì°¨ë‹¨
                if (enabled && !lastSelectedControlId) {
                    showStatus('ì»¨íŠ¸ë¡¤ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”. ë‚´ ì»¨íŠ¸ë¡¤ íƒ­ì—ì„œ ë‚™ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
                    setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                    hidePreviewOverlay();
                    return;
                }
                // ì„ íƒì´ ìˆìœ¼ë©´ ìë™ í™œì„±í™”(í† ê¸€ ì‹¤ìˆ˜ ë°©ì§€)
                const forceEnable = !!lastSelectedControlId;
                requestData.control_enabled = enabled || forceEnable;
                if (requestData.control_enabled && lastSelectedControlId) requestData.control_image_id = lastSelectedControlId;
            } catch(_) {}

            try {
                const response = await fetch('/api/v1/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                const result = await response.json();
                if (!response.ok) {
                    if (response.status === 429) {
                        showStatus(result.detail || 'ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                        setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                        updateProgress(0);
                        hidePreviewOverlay();
                        return;
                    }
                    throw new Error(result.detail || 'Unknown error');
                }
                // Expect { job_id, status: 'queued', position }
                currentJobId = result.job_id || null;
                if (currentJobId) {
                    const pos = (typeof result.position === 'number') ? result.position + 1 : null;
                    const msg = pos ? `ëŒ€ê¸°ì¤‘... (${pos}ë²ˆì§¸)` : 'ëŒ€ê¸°ì¤‘...';
                    showStatus(msg, 'info');
                    setGenerationState(true, 'ëŒ€ê¸°ì¤‘...');
                    updateProgress(0);
                    if (pos) showQueueInfo(pos); else showQueueInfo();
                    startQueuePolling();
                } else {
                    showStatus('ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
            } catch (error) {
                showStatus(`âŒ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'error');
                setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                updateProgress(0); // ìš”ì²­ ì‹¤íŒ¨ ì‹œì—ë„ ì§„í–‰ë¥ ì„ 0%ë¡œ ë¦¬ì…‹
                hidePreviewOverlay();
            }
        }

        // ---- Queue helpers ----
        function showQueueInfo(position){
            const box = document.getElementById('queue-info');
            const posEl = document.getElementById('queue-position');
            const etaEl = document.getElementById('queue-eta');
            if (box) box.style.display = 'block';
            if (posEl) posEl.textContent = (typeof position === 'number') ? `ëŒ€ê¸° ${position}ë²ˆì§¸` : 'ëŒ€ê¸°ì¤‘';
            if (etaEl) etaEl.textContent = '';
        }
        function hideQueueInfo(){
            const box = document.getElementById('queue-info');
            if (box) box.style.display = 'none';
        }
        async function pollQueueOnce(){
            if (!currentJobId) return;
            try {
                const res = await fetch(`/api/v1/jobs/${currentJobId}`);
                if (!res.ok) return;
                const data = await res.json();
                if (data.status === 'queued') {
                    const pos = (typeof data.position === 'number') ? data.position + 1 : null;
                    if (pos) showQueueInfo(pos); else showQueueInfo();
                    // fetch metrics for ETA
                    try {
                        const mRes = await fetch('/api/v1/admin/jobs/metrics?limit=50');
                        if (mRes.ok) {
                            const m = await mRes.json();
                            const etaEl = document.getElementById('queue-eta');
                            const avg = (typeof m.overall_avg_sec === 'number') ? m.overall_avg_sec : null;
                            if (etaEl && avg && pos) {
                                const est = Math.max(1, Math.round(avg * (pos - 1)));
                                etaEl.textContent = `ì˜ˆìƒ ì‹œì‘: ~${est}s í›„`;
                            }
                        }
                    } catch (_) {}
                } else if (data.status === 'running') {
                    hideQueueInfo();
                    stopQueuePolling();
                }
            } catch (e) {}
        }
        function startQueuePolling(){
            stopQueuePolling();
            queueTimer = setInterval(pollQueueOnce, 2000);
        }
        function stopQueuePolling(){
            if (queueTimer) { clearInterval(queueTimer); queueTimer = null; }
        }

        function setGenerationState(isGenerating, text) {
            ui.generateBtn.disabled = isGenerating;
            const cancelBtn = document.getElementById('cancel-btn');
            cancelBtn.disabled = !isGenerating;
            ui.generateBtn.innerHTML = isGenerating ? `<div class="loading-spinner"></div><span>${text}</span>` : `<i class="fas fa-sparkles"></i><span>${text}</span>`;
            if (isGenerating) setResultActionsEnabled(false);
            // ì´ì „ ë°©ì‹: ì˜¤ë²„ë ˆì´ ê´€ë ¨ ë¡œì§ ì œê±°
        }

        function showStatus(message, type = 'info') {
            ui.statusMessage.textContent = message;
            ui.statusContainer.className = `status-container status-${type}`;
            ui.statusContainer.style.display = 'block';
        }

        function updateProgress(percent) {
            const p = Math.max(0, Math.min(100, percent));
            ui.progressBar.style.width = `${p}%`;
            const cfg = (window.APP_CONFIG && window.APP_CONFIG.progress) || {};
            // Title visibility
            try { document.querySelector('.progress-title').style.display = (cfg.showTitle ? '' : 'none'); } catch(_) {}
            // Height
            try { document.querySelector('.progress-container').style.setProperty('--cfg-progress-height', `${cfg.height || 4}px`); } catch(_) {}
            // Percent display modes
            const mode = cfg.percentMode || 'right';
            if (mode === 'none') {
                if (ui.progressText) ui.progressText.style.display = 'none';
                if (ui.progressBubble) ui.progressBubble.style.display = 'none';
                if (ui.progressRight) ui.progressRight.style.display = 'none';
            } else if (mode === 'text') {
                if (ui.progressText) { ui.progressText.style.display = 'block'; ui.progressText.textContent = `${Math.round(p)}%`; }
                if (ui.progressBubble) ui.progressBubble.style.display = 'none';
                if (ui.progressRight) ui.progressRight.style.display = 'none';
            } else {
                // right fixed label
                if (ui.progressText) ui.progressText.style.display = 'none';
                if (ui.progressBubble) ui.progressBubble.style.display = 'none';
                if (ui.progressRight) { ui.progressRight.style.display = 'block'; ui.progressRight.textContent = `${Math.round(p)}%`; }
            }
        }

        function displayImage(imagePath, onRevealDone) {
            // Prepare cross-fade with previous visual
            const container = document.getElementById('result-image-container');
            const currentSrc = ui.resultImage.src;
            let oldLayer = null;
            if ((ui.resultSection.style.display === 'block' && currentSrc)) {
                oldLayer = document.createElement('img');
                oldLayer.className = 'result-image-old is-blurred';
                oldLayer.alt = 'ì´ì „ ì´ë¯¸ì§€';
                oldLayer.src = currentSrc;
                container.appendChild(oldLayer);
            }

            lastImageUrlOriginal = imagePath;
            const cacheBusted = `${imagePath}?t=${new Date().getTime()}`;
            ui.resultImage.src = cacheBusted;
            ui.resultImage.onload = () => {
                ui.placeholderSection.style.display = 'none';
                ui.resultSection.style.display = 'block';
                // Ensure result image is visible (in case we hid it when overlay only)
                ui.resultImage.style.display = 'block';
                // Sync durations with CSS variable from config
                const revealMs = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.revealMs) || 1000;
                const hostCard = document.querySelector('.output-card');
                if (hostCard) {
                    hostCard.style.setProperty('--reveal-duration', `${revealMs}ms`);
                    const easing = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.revealEasing) || 'ease';
                    hostCard.style.setProperty('--reveal-easing', easing);
                }
                // ìƒˆ ì´ë¯¸ì§€ ë¸”ëŸ¬ëŠ” ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì„ ëª…í•˜ê²Œ í˜ì´ë“œì¸
                ui.resultImage.classList.remove('is-blurred');
                ui.resultImage.style.filter = '';
                // ì´ì „ ë ˆì´ì–´ì˜ ë¸”ëŸ¬ëŠ” í˜ì´ë“œì•„ì›ƒê³¼ í•¨ê»˜ ì„œì„œíˆ í•´ì œ
                if (oldLayer) requestAnimationFrame(() => oldLayer.classList.remove('is-blurred'));
                ui.resultImage.classList.add('reveal');
                // Clean up old layer after cross-fade completes
                setTimeout(() => {
                    ui.resultImage.classList.remove('reveal');
                    if (oldLayer && oldLayer.parentNode) oldLayer.parentNode.removeChild(oldLayer);
                    // ì´ì „ ë°©ì‹ ìœ ì§€: ì˜¤ë²„ë ˆì´ ê´€ë ¨ ë¡œì§ ì œê±°
                    if (typeof onRevealDone === 'function') onRevealDone();
                }, Math.max(50, revealMs + 50));
                setResultActionsEnabled(!!lastImageUrlOriginal);
            };
        }

        // --- Loading overlay logic ---
        const overlayEl = document.getElementById('preview-overlay');
        const overlayTipEl = document.getElementById('preview-tip');
        const resultContainer = document.getElementById('result-image-container');
        let tipTimer = null;
        let typingTimer = null;

        function pickTips() {
            const tips = Array.isArray(window.LOADING_TIPS) && window.LOADING_TIPS.length ? window.LOADING_TIPS : [
                'ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”â€¦',
                'ì´ë¯¸ì§€ë¥¼ ì •ì„±ê» ë¹šëŠ” ì¤‘â€¦',
                'ë¹›ê³¼ ê·¸ë¦¼ìë¥¼ ì¡°ìœ¨í•˜ëŠ” ì¤‘â€¦',
            ];
            return tips.slice();
        }

        function setBlurOnTarget(enable) {
            const blurPx = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.blurPx) || 10;
            const hostCard = document.querySelector('.output-card');
            if (hostCard) hostCard.style.setProperty('--blur-amount', `${blurPx}px`);
            const applyBlur = (el) => {
                if (!el) return;
                el.classList.toggle('is-blurred', !!enable);
                // do not force inline filter; let CSS transition handle smooth fade via --overlay-fade
                if (!enable) el.style.filter = '';
            };
            if (ui.resultSection.style.display === 'block' && ui.resultImage.src) {
                applyBlur(ui.resultImage);
            } else {
                const ph = document.querySelector('#placeholder-section .placeholder-card');
                applyBlur(ph || document.getElementById('placeholder-section'));
            }
        }

        function typeText(text, onDone) {
            overlayTipEl.textContent = '';
            const speed = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.typingSpeedMs) || 40;
            let i = 0;
            clearInterval(typingTimer);
            typingTimer = setInterval(() => {
                overlayTipEl.textContent = text.slice(0, i++);
                if (i > text.length) {
                    clearInterval(typingTimer);
                    if (onDone) onDone();
                }
            }, speed);
        }

        function cycleTips() {
            const tips = pickTips();
            let idx = 0;
            const interval = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.messageIntervalMs) || 2200;
            const tick = () => {
                if (!overlayEl.classList.contains('open')) return;
                typeText(tips[idx % tips.length], () => {
                    // wait until next cycle
                });
                idx++;
            };
            tick();
            clearInterval(tipTimer);
            tipTimer = setInterval(tick, interval);
        }

        function showPreviewOverlay() {
            if (!(window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.enabled)) return;
            const fadeMs = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.fadeMs) || 300;
            const hostCard = document.querySelector('.output-card');
            if (hostCard) {
                hostCard.style.setProperty('--overlay-fade', `${fadeMs}ms`);
                const easing = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.overlayEasing) || 'ease';
                hostCard.style.setProperty('--overlay-easing', easing);
            }
            overlayEl.classList.add('open');
            setBlurOnTarget(true);
            cycleTips();
        }

        function hidePreviewOverlay() {
            // allow CSS opacity transition to play; cleanup blur and timers after fade
            overlayEl.classList.remove('open');
            const fadeMs = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.overlayFadeOutMs) ||
                           (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.fadeMs) || 300;
            const hostCard = document.querySelector('.output-card');
            if (hostCard) {
                hostCard.style.setProperty('--overlay-fade', `${fadeMs}ms`);
                const easing = (window.APP_CONFIG && window.APP_CONFIG.loading && window.APP_CONFIG.loading.overlayEasing) || 'ease';
                hostCard.style.setProperty('--overlay-easing', easing);
            }
            setTimeout(() => {
                setBlurOnTarget(false);
                clearInterval(tipTimer);
                clearInterval(typingTimer);
            }, Math.max(50, fadeMs));
        }

        // --- Gallery (History) ---
        const gallery = {
            grid: document.getElementById('gallery-grid'),
            loadMoreBtn: document.getElementById('gallery-load-more')
        };
        let galleryItems = [];
        let nextCursor = null;
        let galleryLoading = false;
        let currentLightboxIndex = -1;
        const PAGE_SIZE = (window.APP_CONFIG && window.APP_CONFIG.gallery && window.APP_CONFIG.gallery.pageSize) || 24;

        // --- Multi-select (ì‚­ì œ) ìƒíƒœ ---
        const gallerySectionEl = document.getElementById('gallery-section');
        const selectToggleBtn = document.getElementById('select-toggle-btn');
        const selectAllBtn = document.getElementById('select-all-btn');
        const clearSelectionBtn = document.getElementById('clear-selection-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const selectedCountEl = document.getElementById('selected-count');
        let selectionMode = false;
        const selectedIds = new Set();

        function setSelectionMode(enable){
            selectionMode = !!enable;
            gallerySectionEl.classList.toggle('selection-mode', selectionMode);
            if (selectToggleBtn) {
                selectToggleBtn.title = selectionMode ? 'ì„ íƒ ì¢…ë£Œ' : 'ì„ íƒ';
                selectToggleBtn.setAttribute('aria-label', selectionMode ? 'ì„ íƒ ì¢…ë£Œ' : 'ì„ íƒ');
                const i = selectToggleBtn.querySelector('i');
                if (i) i.className = selectionMode ? 'fas fa-xmark' : 'fas fa-list-check';
            }
            // ë³´ì¡° ë²„íŠ¼ ê°€ì‹œì„±
            [selectAllBtn, clearSelectionBtn, deleteSelectedBtn, selectedCountEl].forEach(el => { el.style.display = selectionMode ? '' : 'none'; });
            if (!selectionMode) {
                selectedIds.clear();
            }
            updateSelectedCount();
            // ì„ íƒ ì˜¤ë²„ë ˆì´ ë°˜ì˜ ìœ„í•´ ë‹¤ì‹œ ë Œë”
            renderGallery(galleryItems);
        }

        function updateSelectedCount(){
            const n = selectedIds.size;
            if (selectedCountEl) selectedCountEl.textContent = `${n}ê°œ ì„ íƒë¨`;
            if (deleteSelectedBtn) deleteSelectedBtn.disabled = n === 0;
        }

        selectToggleBtn?.addEventListener('click', () => setSelectionMode(!selectionMode));
        selectAllBtn?.addEventListener('click', () => {
            galleryItems.forEach(it => selectedIds.add(it.id));
            // ì¸ë„¤ì¼ í´ë˜ìŠ¤ë¥¼ ì¦‰ì‹œ ë°˜ì˜
            document.querySelectorAll('.gallery-item').forEach(el => el.classList.add('selected'));
            updateSelectedCount();
        });
        clearSelectionBtn?.addEventListener('click', () => {
            selectedIds.clear();
            document.querySelectorAll('.gallery-item').forEach(el => el.classList.remove('selected'));
            updateSelectedCount();
        });
        deleteSelectedBtn?.addEventListener('click', () => {
            if (selectedIds.size === 0) return;
            openBatchDeleteConfirm(Array.from(selectedIds));
        });

        function renderSkeleton(count) {
            const configured = parseInt(document.getElementById('gallery-section').dataset.skeletonCount || String((window.APP_CONFIG && window.APP_CONFIG.gallery && window.APP_CONFIG.gallery.skeletonCount) || 12), 10);
            const n = Number.isFinite(configured) ? configured : (Number.isFinite(count) ? count : 12);
            gallery.grid.innerHTML = '';
            const frag = document.createDocumentFragment();
            for (let i = 0; i < n; i++) {
                const sk = document.createElement('div');
                sk.className = 'skeleton-item';
                frag.appendChild(sk);
            }
            gallery.grid.appendChild(frag);
        }

        let gallerySource = 'generated'; // 'generated' | 'controls'
        const tabGenerated = document.getElementById('tab-generated');
        const tabControls = document.getElementById('tab-controls');
        const galleryTitle = document.getElementById('gallery-title');
        const controlUpload = document.getElementById('control-upload');
        const controlUploadIcon = document.getElementById('control-upload-icon');

        tabGenerated.addEventListener('click', () => switchGallery('generated'));
        tabControls.addEventListener('click', () => switchGallery('controls'));

        function switchGallery(src){
            gallerySource = src;
            tabGenerated.classList.toggle('active', src === 'generated');
            tabControls.classList.toggle('active', src === 'controls');
            if (src === 'controls') {
                galleryTitle.innerHTML = '<i class="fas fa-pen-ruler"></i> ë‚´ ì»¨íŠ¸ë¡¤';
                if (controlUploadIcon) controlUploadIcon.style.display = '';
                setSelectionMode(false);
            } else {
                galleryTitle.innerHTML = '<i class="fas fa-clock-rotate-left"></i> ìµœê·¼ ìƒì„± ì´ë¯¸ì§€';
                if (controlUploadIcon) controlUploadIcon.style.display = 'none';
            }
            currentPage = 1;
            fetchGallery(true);
        }

        async function uploadControlFile(file){
            if (!file) return;
            try {
                const fd = new FormData();
                fd.append('file', file);
                const res = await fetch('/api/v1/controls/upload', { method: 'POST', body: fd });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                showStatus('ì»¨íŠ¸ë¡¤ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                if (gallerySource === 'controls') fetchGallery(true);
            } catch (e) {
                showStatus(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
            } finally {
                if (controlUpload) controlUpload.value = '';
            }
        }
        if (controlUploadIcon) controlUploadIcon.addEventListener('click', () => controlUpload && controlUpload.click());
        controlUpload.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) uploadControlFile(file);
        });

        async function fetchGallery(initial = false) {
            if (galleryLoading) return;
            galleryLoading = true;
            renderSkeleton(12);
            try {
                const params = new URLSearchParams();
                params.set('page', String(currentPage));
                params.set('size', String(PAGE_SIZE));
                const endpoint = (gallerySource === 'controls') ? '/api/v1/controls' : '/api/v1/images';
                const res = await fetch(`${endpoint}?${params.toString()}`);
                if (!res.ok) throw new Error(`Failed to fetch images (${res.status})`);
                const data = await res.json();
                const items = Array.isArray(data.items) ? data.items : [];
                renderGallery(items, true);
                renderPagination(data.page, data.total_pages);
                gallery.loadMoreBtn.style.display = 'none';
            } catch (e) {
                console.error(e);
            } finally {
                galleryLoading = false;
            }
        }

        function renderGallery(items) {
            galleryItems = [];
            gallery.grid.innerHTML = '';
            const startIndex = galleryItems.length;
            galleryItems = items.slice();
            const frag = document.createDocumentFragment();
            items.forEach((it, idx) => {
                const i = startIndex + idx;
                const a = document.createElement('button');
                a.className = 'gallery-item';
                a.dataset.imageId = it.id;
                a.setAttribute('aria-label', 'ì´ë¯¸ì§€ ë³´ê¸°');
                const img = document.createElement('img');
                img.className = 'gallery-thumb';
                img.src = it.thumb_url || it.url;
                img.alt = gallerySource === 'controls' ? 'ì»¨íŠ¸ë¡¤ ì´ë¯¸ì§€' : (it?.meta?.prompt ? it.meta.prompt : 'ìƒì„± ì´ë¯¸ì§€');
                a.appendChild(img);
                // selection overlay
                const sel = document.createElement('div');
                sel.className = 'gallery-select';
                sel.innerHTML = '<i class="fas fa-check"></i>';
                a.appendChild(sel);

                if (selectionMode && selectedIds.has(it.id)) a.classList.add('selected');
                a.addEventListener('click', () => {
                    if (gallerySource === 'controls') {
                        // ì»¨íŠ¸ë¡¤ ì„ íƒ í† ê¸€: ì„ íƒëœ ì»¨íŠ¸ë¡¤ ID ì €ì¥/í‘œì‹œ
                        try {
                            localStorage.setItem('selectedControlId', it.id);
                        } catch(_) {}
                        // ì´ì „ ë°©ì‹: ì‘ì€ ì¸ë„¤ì¼ë§Œ ê°±ì‹ 
                        try {
                            // remove inline thumb; use floating preview instead
                            const thumb = document.getElementById('control-selected-thumb');
                            if (thumb) { thumb.style.display='none'; }
                            const floating = document.getElementById('control-floating');
                            const floatingImg = document.getElementById('control-floating-img');
                            if (floating) floating.style.display = 'flex';
                            if (floatingImg) {
                                floatingImg.style.display = 'block';
                                floatingImg.src = '';
                                floatingImg.src = it.thumb_url || it.url;
                            }
                            // í”Œë ˆì´ìŠ¤í™€ë”ëŠ” ìœ ì§€ (ë…ë¦½ ë ˆì´ì–´ì´ë¯€ë¡œ ê°€ë¦¬ì§€ ì•ŠìŒ)
                            const chk = document.getElementById('control-enabled');
                            if (chk) chk.checked = true;
                        } catch(_) {}
                        showStatus('ì»¨íŠ¸ë¡¤ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ControlNet í† ê¸€ì„ ì¼œë©´ ì ìš©ë©ë‹ˆë‹¤.', 'info');
                    } else {
                        openLightboxAt(i);
                    }
                });
                a.addEventListener('click', (ev) => {
                    if (!selectionMode) return; // ê¸°ë³¸ ë¼ì´íŠ¸ë°•ìŠ¤ ë™ì‘ì€ ìœ„ì—ì„œ ì²˜ë¦¬
                    ev.preventDefault();
                    ev.stopPropagation();
                    const id = it.id;
                    if (selectedIds.has(id)) {
                        selectedIds.delete(id);
                        a.classList.remove('selected');
                    } else {
                        selectedIds.add(id);
                        a.classList.add('selected');
                    }
                    updateSelectedCount();
                }, true);
                frag.appendChild(a);
            });
            gallery.grid.appendChild(frag);
        }

        // Pagination UI
        let currentPage = 1;
        const pagination = document.createElement('div');
        pagination.className = 'gallery-pagination';
        document.getElementById('gallery-section').appendChild(pagination);

        function renderPagination(page, totalPages) {
            currentPage = page;
            pagination.innerHTML = '';
            const left = document.createElement('div');
            left.className = 'gallery-pagination-left';
            const center = document.createElement('div');
            center.className = 'gallery-pagination-pages';
            const right = document.createElement('div');
            right.className = 'gallery-pagination-right';

            const makeBtn = (label, disabled, onClick) => {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.textContent = label;
                btn.disabled = disabled;
                if (onClick) btn.addEventListener('click', onClick);
                return btn;
            };
            const makeIconBtn = (iconClass, disabled, onClick, ariaLabel) => {
                const btn = document.createElement('button');
                btn.className = 'page-btn--icon';
                btn.disabled = disabled;
                btn.setAttribute('type', 'button');
                btn.setAttribute('aria-label', ariaLabel || '');
                const i = document.createElement('i');
                i.className = iconClass;
                btn.appendChild(i);
                if (onClick) btn.addEventListener('click', onClick);
                return btn;
            };

            left.appendChild(makeIconBtn('fas fa-angles-left', page === 1, () => goToPage(1), 'ì²˜ìŒ'));
            left.appendChild(makeIconBtn('fas fa-angle-left', page === 1, () => goToPage(page - 1), 'ì´ì „'));

            // simple number window
            const windowSize = 5;
            const start = Math.max(1, page - Math.floor(windowSize/2));
            const end = Math.min(totalPages, start + windowSize - 1);
            for (let p = start; p <= end; p++) {
                const num = makeBtn(String(p), p === page, () => goToPage(p));
                if (p === page) num.classList.add('active');
                center.appendChild(num);
            }

            right.appendChild(makeIconBtn('fas fa-angle-right', page >= totalPages, () => goToPage(page + 1), 'ë‹¤ìŒ'));
            right.appendChild(makeIconBtn('fas fa-angles-right', page >= totalPages, () => goToPage(totalPages), 'ë§ˆì§€ë§‰'));

            pagination.appendChild(left);
            pagination.appendChild(center);
            pagination.appendChild(right);
        }

        function goToPage(page) {
            if (page < 1) return;
            currentPage = page;
            fetchGallery(true);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openLightboxAt(index) {
            if (index < 0 || index >= galleryItems.length) return;
            currentLightboxIndex = index;
            const item = galleryItems[index];
            openLightbox(item.url, item?.meta?.prompt || 'í™•ëŒ€ëœ ì´ë¯¸ì§€', item);
        }

        function gotoPrev() {
            if (currentLightboxIndex <= 0) return;
            openLightboxAt(currentLightboxIndex - 1);
        }

        function gotoNext() {
            if (currentLightboxIndex < 0) return;
            if (currentLightboxIndex >= galleryItems.length - 1) return;
            openLightboxAt(currentLightboxIndex + 1);
        }

        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('open')) return;
            if (e.key === 'ArrowLeft') gotoPrev();
            if (e.key === 'ArrowRight') gotoNext();
        });

        // After image generation completes, refresh gallery head
        const _displayImageOriginal = displayImage;
        displayImage = function(imagePath, onRevealDone) {
            _displayImageOriginal(imagePath, onRevealDone);
            goToPage(1);
        };

        // (ë‹¨ê±´ ì‚­ì œ ê¸°ëŠ¥ ì œê±°ë¨)

        // Batch confirm for multiple deletions
        function ensureBatchConfirmModal() {
            let ov = document.getElementById('confirm-overlay-batch');
            if (ov) return ov;
            ov = document.createElement('div');
            ov.className = 'confirm-overlay';
            ov.id = 'confirm-overlay-batch';
            ov.innerHTML = `
                <div class="confirm-card">
                    <h3 class="confirm-title"><i class="fas fa-trash"></i> ì„ íƒ ì‚­ì œ</h3>
                    <p class="confirm-text" id="batch-confirm-text">ì„ íƒí•œ ì´ë¯¸ì§€ë¥¼ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í• ê¹Œìš”?</p>
                    <div class="confirm-actions">
                        <button class="btn-ghost" id="batch-confirm-cancel">ì·¨ì†Œ</button>
                        <button class="btn-danger" id="batch-confirm-ok">ì‚­ì œ</button>
                    </div>
                </div>`;
            document.body.appendChild(ov);
            ov.addEventListener('click', (e) => { if (e.target === ov) closeBatchConfirm(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && ov.classList.contains('open')) closeBatchConfirm(); });
            return ov;
        }
        let pendingBatchIds = [];
        function openBatchDeleteConfirm(ids) {
            pendingBatchIds = Array.isArray(ids) ? ids.slice() : [];
            const ov = ensureBatchConfirmModal();
            const textEl = document.getElementById('batch-confirm-text');
            if (textEl) textEl.textContent = `ì„ íƒí•œ ${pendingBatchIds.length}ê°œ ì´ë¯¸ì§€ë¥¼ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í• ê¹Œìš”? (ë‚˜ì¤‘ì— ë³µêµ¬ ê°€ëŠ¥)`;
            ov.classList.add('open');
            ov.setAttribute('aria-hidden', 'false');
            const cancelBtn = document.getElementById('batch-confirm-cancel');
            const okBtn = document.getElementById('batch-confirm-ok');
            cancelBtn.onclick = closeBatchConfirm;
            okBtn.onclick = doBatchDelete;
        }
        function closeBatchConfirm() {
            const ov = document.getElementById('confirm-overlay-batch');
            if (ov) { ov.classList.remove('open'); ov.setAttribute('aria-hidden', 'true'); }
            pendingBatchIds = [];
        }
        async function doBatchDelete() {
            if (!pendingBatchIds.length) return;
            try {
                const tasks = pendingBatchIds.map(id => fetch(`/api/v1/images/${id}/delete`, { method: 'POST' }));
                const results = await Promise.allSettled(tasks);
                const failed = results.filter(r => r.status === 'rejected' || (r.value && !r.value.ok)).length;
                if (failed > 0) {
                    showStatus(`ì¼ë¶€ ì‚­ì œ ì‹¤íŒ¨: ${failed}ê±´`, 'error');
                }
            } catch (e) {
                showStatus('ì„ íƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                closeBatchConfirm();
                // ìƒíƒœ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨
                selectedIds.clear();
                setSelectionMode(false);
                fetchGallery(true);
            }
        }

        // --- Lightbox Logic ---
        const lightbox = document.getElementById('image-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxCloseBtn = document.getElementById('lightbox-close');

        function openLightbox(src, alt = '', metaItem = null) {
            lightboxImage.src = src;
            lightboxImage.alt = alt || 'í™•ëŒ€ëœ ì´ë¯¸ì§€';
            lightbox.classList.add('open');
            lightbox.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            // Fill meta panel if available
            try {
                const wf = (metaItem && metaItem.meta && metaItem.meta.workflow_name) || (metaItem && metaItem.workflow_name) || '-';
                const createdAt = metaItem && (metaItem.created_at || metaItem.createdAt);
                const createdText = createdAt ? new Date(createdAt * 1000).toLocaleString() : '';
                const prompt = (metaItem && metaItem.meta && metaItem.meta.prompt) || (metaItem && metaItem.prompt) || '';
                const wfEl = document.getElementById('lb-workflow');
                const ctEl = document.getElementById('lb-created');
                const prEl = document.getElementById('lb-prompt');
                if (wfEl) wfEl.value = wf || '';
                if (ctEl) ctEl.value = createdText || '';
                if (prEl) prEl.value = prompt || '';
            } catch (_) {}
            // ensure fade-in restarts
            const bodyEl = document.querySelector('.lightbox-body');
            if (bodyEl) {
                // Apply configurable CSS variables from APP_CONFIG.lightbox if present
                try {
                    const lc = (window.APP_CONFIG && window.APP_CONFIG.lightbox) || {};
                    if (lc.metaWidth) bodyEl.style.setProperty('--lb-meta-width', `${lc.metaWidth}px`);
                    if (lc.fadeMs) bodyEl.style.setProperty('--lb-fade', `${lc.fadeMs}ms`);
                    const media = document.querySelector('.lightbox-media');
                    const meta = document.getElementById('lightbox-meta');
                    if (media && lc.mediaBg) media.style.setProperty('--lb-media-bg', lc.mediaBg);
                    if (meta && lc.metaBg) meta.style.setProperty('--lb-meta-bg', lc.metaBg);
                } catch (_) {}
                bodyEl.style.opacity = '0';
                requestAnimationFrame(() => { bodyEl.style.opacity = ''; });
            }
        }

        function closeLightbox() {
            lightbox.classList.remove('open');
            lightbox.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }

        ui.resultImage.addEventListener('click', () => {
            if (!ui.resultImage.src) return;
            openLightbox(ui.resultImage.src, ui.resultImage.alt);
        });

        // ì´ì „ ë°©ì‹: ì˜¤ë²„ë ˆì´ ê´€ë ¨ ë¡œì§ ì œê±°

        lightboxCloseBtn.addEventListener('click', closeLightbox);

        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && lightbox.classList.contains('open')) {
                closeLightbox();
            }
        });

        async function handleCancelClick() {
            try {
                const response = await fetch('/api/v1/cancel', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Cancel failed');
                showStatus(result.message, 'info');
                // ì»¨íŠ¸ë¡¤ ì½”ë„ˆëŠ” ìœ ì§€(ì‚¬ìš©ì ì„ íƒ ìƒíƒœê°€ ë‚¨ë„ë¡)
            } catch (error) {
                showStatus(`âŒ ì·¨ì†Œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        }
        
        document.querySelectorAll('textarea.form-input:not([readonly])').forEach(t => {
            t.addEventListener('input', () => autoResizeTextarea(t));
            autoResizeTextarea(t);
        });

        loadWorkflows();
        // ì´ˆê¸° ì§„ì…: ìƒì„± íƒ­ ë¡œë“œ
        switchGallery('generated');
    });
    </script>
    <script src="/static/js/app_config.js"></script>
    <script src="/static/js/loading_tips.js"></script>
    
    <!-- Lightbox (ì´ë¯¸ì§€ í™•ëŒ€ ë³´ê¸°) -->
    <div class="lightbox-overlay" id="image-lightbox" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="lightbox-content" role="document">
            <button class="lightbox-close" id="lightbox-close" type="button" aria-label="ë‹«ê¸°">
                <i class="fas fa-times"></i>
            </button>
            <div class="lightbox-body">
                <div class="lightbox-media">
                    <img id="lightbox-image" alt="í™•ëŒ€ëœ ì´ë¯¸ì§€" />
                </div>
                <aside class="lightbox-meta" id="lightbox-meta" aria-live="polite">
                    <h4 class="meta-title"><i class="fas fa-circle-info"></i> ì´ë¯¸ì§€ ì •ë³´</h4>
                    <div class="meta-fields">
                        <label class="meta-label">ì›Œí¬í”Œë¡œìš°</label>
                        <input class="meta-input" id="lb-workflow" type="text" readonly value="" />
                        <label class="meta-label">ìƒì„± ì‹œê°„</label>
                        <input class="meta-input" id="lb-created" type="text" readonly value="" />
                        <label class="meta-label">í”„ë¡¬í”„íŠ¸</label>
                        <textarea class="meta-textarea" id="lb-prompt" rows="6" readonly></textarea>
                    </div>
                </aside>
            </div>
        </div>
    </div>
    <script src="/static/js/prompt_translate.js"></script>
    <script src="/static/js/control_canvas.js"></script>
</body>
</html>