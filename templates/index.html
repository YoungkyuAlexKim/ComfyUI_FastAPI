<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI FastAPI - AI ì´ë¯¸ì§€ ìƒì„±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/css/styles.css?v=20250918_01" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <div class="app-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h1 class="app-title"><i class="fas fa-palette"></i> ComfyUI AI ìƒì„±ê¸°</h1>
                </div>
                <div class="workflow-section">
                    <div class="workflow-section-header">
                        <h3 class="sidebar-title"><i class="fas fa-cogs"></i> ì›Œí¬í”Œë¡œìš°</h3>
                    </div>
                    <div class="workflow-list" id="workflow-list"></div>
                </div>
                <div class="sidebar-footer">
                    <div class="current-workflow" id="current-workflow">
                        <small class="workflow-info">
                            <i class="fas fa-info-circle"></i> ì„ íƒëœ ì›Œí¬í”Œë¡œìš°: <span id="selected-workflow-name">ì—†ìŒ</span>
                        </small>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div class="input-panel">
                    <div class="input-card">
                        <div class="card-header">
                            <div class="workflow-info-header">
                                <h2 class="workflow-name-display" id="workflow-name-display">ì›Œí¬í”Œë¡œìš°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
                                <p class="workflow-description-display" id="workflow-description-display">ì™¼ìª½ì—ì„œ ì‚¬ìš©í•  ì›Œí¬í”Œë¡œìš°ë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="user_prompt"><i class="fas fa-comment-dots"></i> í”„ë¡¬í”„íŠ¸ (ë‚´ìš©)</label>
                                    <p class="prompt-suggestion" id="prompt-suggestion-text" style="display: none;"></p>
                                    <div class="input-with-action">
                                        <textarea class="form-input" id="user_prompt" placeholder="ê·¸ë¦¬ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í•œë³µì„ ì…ì€ ì†Œë…€)..." rows="5">{{ default_user_prompt }}</textarea>
                                        <button class="translate-btn translate-btn--icon" data-target="user_prompt" data-tooltip="Danbooru íƒœê·¸ë¡œ ë³€í™˜" aria-label="Danbooru íƒœê·¸ë¡œ ë³€í™˜">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="style_prompt"><i class="fas fa-palette"></i> ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ìŠ¤íƒ€ì¼ & í’ˆì§ˆ)</label>
                                    <textarea class="form-input" id="style_prompt" rows="2" readonly>{{ default_style_prompt }}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="negative_prompt"><i class="fas fa-ban"></i> ì‹œìŠ¤í…œ ë¶€ì • í”„ë¡¬í”„íŠ¸</label>
                                    <textarea class="form-input" id="negative_prompt" rows="2" readonly>{{ default_negative_prompt }}</textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label"><i class="fas fa-crop-alt"></i> ì´ë¯¸ì§€ ë¹„ìœ¨</label>
                                    <div class="aspect-ratio-group" id="aspect-ratio-group">
                                        <button class="aspect-ratio-btn selected" data-ratio="square">
                                            <i class="icon fas fa-square"></i>
                                            <span class="label">Square</span>
                                        </button>
                                        <button class="aspect-ratio-btn" data-ratio="landscape">
                                            <i class="icon fas fa-window-maximize"></i>
                                            <span class="label">Landscape</span>
                                        </button>
                                        <button class="aspect-ratio-btn" data-ratio="portrait">
                                            <i class="icon fas fa-mobile-screen-button"></i>
                                            <span class="label">Portrait</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="status-container" id="status-container" style="display: none;"><p id="status-message"></p></div>
                        </div>
                    </div>
                </div>
                <div class="output-panel">
                    <div class="control-section">
                        <div class="seed-section">
                        <div class="seed-input-group">
                            <div class="seed-input-wrapper">
                                <label class="seed-label" for="seed"><i class="fas fa-dice"></i> ì‹œë“œê°’</label>
                                <input type="number" class="seed-input" id="seed" placeholder="ëœë¤" min="0">
                                <small class="seed-hint">ë™ì¼ ì´ë¯¸ì§€ ì¬ìƒì„±ìš©</small>
                            </div>
                        </div>
                        </div>
                    </div>
                    <!-- ë¡œë”©ë°”ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ë¶„ë¦¬ -->
                    <div class="progress-section" id="progress-section">
                        <h3 class="progress-title"><i class="fas fa-clock"></i> ìƒì„± ì§„í–‰ë¥ </h3>
                        <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                        <div class="progress-text" id="progress-text">0%</div>
                    </div>
                    
                    <div class="output-card">
                        <div class="output-toolbar">
                            <button class="generate-btn" id="generate-btn">
                                <i class="fas fa-sparkles"></i> <span>ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</span>
                            </button>
                            <button class="cancel-btn" id="cancel-btn" disabled>
                                <i class="fas fa-stop-circle"></i> <span>ìƒì„± ì·¨ì†Œ</span>
                            </button>
                        </div>
                        <div class="placeholder-section" id="placeholder-section">
                             <div class="placeholder-card">
                                <h3 class="placeholder-title"><i class="fas fa-magic"></i> AI ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼</h3>
                                <div class="placeholder-container">
                                    <div class="placeholder-icon"><i class="fas fa-image"></i></div>
                                    <p class="placeholder-text">ê·¸ë¦¬ê³  ì‹¶ì€ ë‚´ìš©ì„ í”„ë¡¬í”„íŠ¸ì— ì…ë ¥í•˜ê³ <br>"ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
                                </div>
                            </div>
                        </div>
                        <div class="result-section" id="result-section" style="display: none;">
                             <div class="result-card">
                                <div class="result-content">
                                    <h3 class="result-title"><i class="fas fa-image"></i> ìƒì„±ëœ ì´ë¯¸ì§€</h3>
                                    <div class="image-container">
                                        <img id="result-image" src="" alt="ìƒì„±ëœ ì´ë¯¸ì§€ ê²°ê³¼" class="result-image">
                                    </div>
                                    <p class="result-hint">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="gallery-panel">
                    <div class="gallery-section" id="gallery-section" data-skeleton-count="12">
                        <div class="gallery-card">
                            <h3 class="gallery-title"><i class="fas fa-clock-rotate-left"></i> ìµœê·¼ ìƒì„± ì´ë¯¸ì§€</h3>
                            <div class="gallery-grid" id="gallery-grid"></div>
                            <button class="gallery-load-more" id="gallery-load-more" style="display:none;">
                                <i class="fas fa-chevron-down"></i> ë” ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script id="workflows-sizes-data" type="application/json">{{ workflows_sizes_json | safe }}</script>
    <script id="workflow-default-prompts-data" type="application/json">{{ workflow_default_prompts_json | safe }}</script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        let currentWorkflow = null;
        let selectedAspectRatio = 'square';
        const workflowsSizes = JSON.parse(document.getElementById('workflows-sizes-data').textContent);
        const workflowDefaultPrompts = JSON.parse(document.getElementById('workflow-default-prompts-data').textContent);

        const ui = {
            workflowList: document.getElementById('workflow-list'),
            selectedWorkflowName: document.getElementById('selected-workflow-name'),
            workflowNameDisplay: document.getElementById('workflow-name-display'),
            workflowDescriptionDisplay: document.getElementById('workflow-description-display'),
            generateBtn: document.getElementById('generate-btn'),
            userPromptInput: document.getElementById('user_prompt'),
            stylePromptInput: document.getElementById('style_prompt'),
            negativePromptInput: document.getElementById('negative_prompt'),
            promptSuggestionText: document.getElementById('prompt-suggestion-text'),
            aspectRatioGroup: document.getElementById('aspect-ratio-group'),
            seedInput: document.getElementById('seed'),
            progressSection: document.getElementById('progress-section'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            statusContainer: document.getElementById('status-container'),
            statusMessage: document.getElementById('status-message'),
            placeholderSection: document.getElementById('placeholder-section'),
            resultSection: document.getElementById('result-section'),
            resultImage: document.getElementById('result-image'),
        };

        const ws = new WebSocket(`ws://${window.location.host}/ws/status`);
        ws.onopen = () => console.log("âœ… WebSocket connected");
        ws.onmessage = handleWebSocketMessage;
        ui.generateBtn.addEventListener('click', handleGenerateClick);
        const cancelBtn = document.getElementById('cancel-btn');
        cancelBtn.addEventListener('click', handleCancelClick);
        ui.promptSuggestionText.addEventListener('click', handleSuggestionClick);

        ui.aspectRatioGroup.addEventListener('click', (e) => {
            const button = e.target.closest('.aspect-ratio-btn');
            if (button) {
                selectedAspectRatio = button.dataset.ratio;
                document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn === button);
                });
            }
        });

        async function loadWorkflows() {
            try {
                const response = await fetch('/api/v1/workflows');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.workflows && data.workflows.length > 0) {
                    renderWorkflows(data.workflows);
                    selectWorkflow(data.workflows[0]);
                } else {
                    ui.workflowList.innerHTML = `<div class="workflow-error">ì›Œí¬í”Œë¡œìš°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
            } catch (error) {
                console.error('Workflow load error:', error);
            }
        }

        function renderWorkflows(workflows) {
            ui.workflowList.innerHTML = workflows.map(wf => `
                <div class="workflow-item" data-workflow-id="${wf.id}">
                    <div class="workflow-item-header">
                        <div class="workflow-icon"><i class="fas fa-project-diagram"></i></div>
                        <div class="workflow-item-info">
                            <div class="workflow-name">${wf.name}</div>
                            <div class="workflow-description">${wf.description}</div>
                        </div>
                    </div>
                </div>`).join('');
            
            ui.workflowList.querySelectorAll('.workflow-item').forEach((item, i) => {
                item.addEventListener('click', () => selectWorkflow(workflows[i]));
            });
        }
        
        function selectWorkflow(workflow) {
            currentWorkflow = workflow;
            
            document.querySelectorAll('.workflow-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.workflowId === workflow.id);
            });
            ui.selectedWorkflowName.textContent = workflow.name;

            // ë©”ì¸ í—¤ë” ì—…ë°ì´íŠ¸
            ui.workflowNameDisplay.textContent = workflow.name;
            ui.workflowNameDisplay.classList.add('selected');
            ui.workflowDescriptionDisplay.textContent = workflow.description || 'ì„ íƒëœ ì›Œí¬í”Œë¡œìš°ë¡œ ê³ í’ˆì§ˆ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”';

            // ì›Œí¬í”Œë¡œìš°ë³„ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •
            const defaultPrompt = workflowDefaultPrompts[workflow.id] || '';
            ui.userPromptInput.value = defaultPrompt;
            autoResizeTextarea(ui.userPromptInput);

            ui.stylePromptInput.value = workflow.style_prompt;
            ui.negativePromptInput.value = workflow.negative_prompt;
            
            if (workflow.recommended_prompt) {
                ui.promptSuggestionText.innerHTML = `âœ¨ ì¶”ì²œ: <span class="suggestion-tags">${workflow.recommended_prompt}</span> (í´ë¦­í•˜ì—¬ ì¶”ê°€)`;
                ui.promptSuggestionText.style.display = 'block';
            } else {
                ui.promptSuggestionText.style.display = 'none';
            }
        }

        function handleSuggestionClick() {
            if (!currentWorkflow || !currentWorkflow.recommended_prompt) return;
            const cleanTags = (str) => str.split(',').map(tag => tag.trim()).filter(Boolean);
            const existingTags = new Set(cleanTags(ui.userPromptInput.value.toLowerCase()));
            const recommendedTags = cleanTags(currentWorkflow.recommended_prompt);
            const newTags = recommendedTags.filter(tag => !existingTags.has(tag.toLowerCase()));
            if (newTags.length > 0) {
                const newTagsString = newTags.join(', ');
                const currentPrompt = ui.userPromptInput.value.trim();
                ui.userPromptInput.value = currentPrompt ? newTagsString + ', ' + currentPrompt : newTagsString;
                autoResizeTextarea(ui.userPromptInput);
            }
        }

        function handleWebSocketMessage(event) {
            const data = JSON.parse(event.data);
            if (data.progress !== undefined) updateProgress(data.progress);
            if (data.status === 'running') setGenerationState(true, 'AI ìƒì„± ì¤‘...');
            if (data.status === 'complete') {
                showStatus('ğŸ‰ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!', 'success');
                setGenerationState(false, 'ìƒˆ ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                updateProgress(0); // ì™„ë£Œ í›„ ì§„í–‰ë¥ ì„ 0%ë¡œ ë¦¬ì…‹
                if (data.image_path) displayImage(data.image_path);
            }
            if (data.status === 'cancelling') {
                showStatus('â¸ï¸ ì·¨ì†Œ ìš”ì²­ ì „ì†¡ë¨...', 'info');
            }
            if (data.status === 'cancelled') {
                showStatus('ğŸ›‘ ì´ë¯¸ì§€ ìƒì„±ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.', 'error');
                setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                updateProgress(0);
            }
            if (data.error) {
                showStatus(`âŒ ì˜¤ë¥˜: ${data.error}`, 'error');
                setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                updateProgress(0); // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì§„í–‰ë¥ ì„ 0%ë¡œ ë¦¬ì…‹
            }
        }

        async function handleGenerateClick() {
            if (!currentWorkflow) return showStatus('ì›Œí¬í”Œë¡œìš°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            if (!ui.userPromptInput.value.trim()) return showStatus('ê·¸ë¦¬ê³  ì‹¶ì€ ë‚´ìš©ì„ í”„ë¡¬í”„íŠ¸ì— ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');

            setGenerationState(true, 'ìš”ì²­ ì²˜ë¦¬ ì¤‘...');
            showStatus('ì„œë²„ì— ìƒì„± ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤...', 'info');

            const requestData = {
                user_prompt: ui.userPromptInput.value.trim(),
                aspect_ratio: selectedAspectRatio,
                workflow_id: currentWorkflow.id,
                seed: ui.seedInput.value ? parseInt(ui.seedInput.value, 10) : null
            };

            try {
                const response = await fetch('/api/v1/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Unknown error');
                showStatus(result.message, 'info');
            } catch (error) {
                showStatus(`âŒ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'error');
                setGenerationState(false, 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°');
                updateProgress(0); // ìš”ì²­ ì‹¤íŒ¨ ì‹œì—ë„ ì§„í–‰ë¥ ì„ 0%ë¡œ ë¦¬ì…‹
            }
        }

        function setGenerationState(isGenerating, text) {
            ui.generateBtn.disabled = isGenerating;
            const cancelBtn = document.getElementById('cancel-btn');
            cancelBtn.disabled = !isGenerating;
            ui.generateBtn.innerHTML = isGenerating ? `<div class="loading-spinner"></div><span>${text}</span>` : `<i class="fas fa-sparkles"></i><span>${text}</span>`;
        }

        function showStatus(message, type = 'info') {
            ui.statusMessage.textContent = message;
            ui.statusContainer.className = `status-container status-${type}`;
            ui.statusContainer.style.display = 'block';
        }

        function updateProgress(percent) {
            ui.progressBar.style.width = `${percent}%`;
            ui.progressText.textContent = `${Math.round(percent)}%`;
        }

        function displayImage(imagePath) {
            ui.resultImage.src = `${imagePath}?t=${new Date().getTime()}`;
            ui.resultImage.onload = () => {
                ui.placeholderSection.style.display = 'none';
                ui.resultSection.style.display = 'block';
            };
        }

        // --- Gallery (History) ---
        const gallery = {
            grid: document.getElementById('gallery-grid'),
            loadMoreBtn: document.getElementById('gallery-load-more')
        };
        let galleryItems = [];
        let nextCursor = null;
        let galleryLoading = false;
        let currentLightboxIndex = -1;
        const PAGE_SIZE = (window.APP_CONFIG && window.APP_CONFIG.gallery && window.APP_CONFIG.gallery.pageSize) || 24;

        function renderSkeleton(count) {
            const configured = parseInt(document.getElementById('gallery-section').dataset.skeletonCount || String((window.APP_CONFIG && window.APP_CONFIG.gallery && window.APP_CONFIG.gallery.skeletonCount) || 12), 10);
            const n = Number.isFinite(configured) ? configured : (Number.isFinite(count) ? count : 12);
            gallery.grid.innerHTML = '';
            const frag = document.createDocumentFragment();
            for (let i = 0; i < n; i++) {
                const sk = document.createElement('div');
                sk.className = 'skeleton-item';
                frag.appendChild(sk);
            }
            gallery.grid.appendChild(frag);
        }

        async function fetchGallery(initial = false) {
            if (galleryLoading) return;
            galleryLoading = true;
            renderSkeleton(12);
            try {
                const params = new URLSearchParams();
                params.set('page', String(currentPage));
                params.set('size', String(PAGE_SIZE));
                const res = await fetch(`/api/v1/images?${params.toString()}`);
                if (!res.ok) throw new Error(`Failed to fetch images (${res.status})`);
                const data = await res.json();
                const items = Array.isArray(data.items) ? data.items : [];
                renderGallery(items, true);
                renderPagination(data.page, data.total_pages);
                gallery.loadMoreBtn.style.display = 'none';
            } catch (e) {
                console.error(e);
            } finally {
                galleryLoading = false;
            }
        }

        function renderGallery(items) {
            galleryItems = [];
            gallery.grid.innerHTML = '';
            const startIndex = galleryItems.length;
            galleryItems = items.slice();
            const frag = document.createDocumentFragment();
            items.forEach((it, idx) => {
                const i = startIndex + idx;
                const a = document.createElement('button');
                a.className = 'gallery-item';
                a.setAttribute('aria-label', 'ì´ë¯¸ì§€ ë³´ê¸°');
                const img = document.createElement('img');
                img.className = 'gallery-thumb';
                img.src = it.thumb_url || it.url;
                img.alt = it?.meta?.prompt ? it.meta.prompt : 'ìƒì„± ì´ë¯¸ì§€';
                a.appendChild(img);
                // trash icon
                const trash = document.createElement('div');
                trash.className = 'gallery-trash';
                trash.innerHTML = '<i class="fas fa-trash"></i>';
                trash.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    openDeleteConfirm(it.id);
                });
                a.appendChild(trash);
                a.addEventListener('click', () => openLightboxAt(i));
                frag.appendChild(a);
            });
            gallery.grid.appendChild(frag);
        }

        // Pagination UI
        let currentPage = 1;
        const pagination = document.createElement('div');
        pagination.className = 'gallery-pagination';
        document.getElementById('gallery-section').appendChild(pagination);

        function renderPagination(page, totalPages) {
            currentPage = page;
            pagination.innerHTML = '';
            const makeBtn = (label, disabled, onClick) => {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.textContent = label;
                btn.disabled = disabled;
                if (onClick) btn.addEventListener('click', onClick);
                return btn;
            };
            const first = makeBtn('ì²˜ìŒ', page === 1, () => goToPage(1));
            const prev = makeBtn('ì´ì „', page === 1, () => goToPage(page - 1));
            const next = makeBtn('ë‹¤ìŒ', page >= totalPages, () => goToPage(page + 1));
            const last = makeBtn('ë§ˆì§€ë§‰', page >= totalPages, () => goToPage(totalPages));
            pagination.appendChild(first);
            pagination.appendChild(prev);
            // simple number window
            const windowSize = 5;
            const start = Math.max(1, page - Math.floor(windowSize/2));
            const end = Math.min(totalPages, start + windowSize - 1);
            for (let p = start; p <= end; p++) {
                const num = makeBtn(String(p), p === page, () => goToPage(p));
                if (p === page) num.classList.add('active');
                pagination.appendChild(num);
            }
            pagination.appendChild(next);
            pagination.appendChild(last);
        }

        function goToPage(page) {
            if (page < 1) return;
            currentPage = page;
            fetchGallery(true);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openLightboxAt(index) {
            if (index < 0 || index >= galleryItems.length) return;
            currentLightboxIndex = index;
            const item = galleryItems[index];
            openLightbox(item.url, item?.meta?.prompt || 'í™•ëŒ€ëœ ì´ë¯¸ì§€');
        }

        function gotoPrev() {
            if (currentLightboxIndex <= 0) return;
            openLightboxAt(currentLightboxIndex - 1);
        }

        function gotoNext() {
            if (currentLightboxIndex < 0) return;
            if (currentLightboxIndex >= galleryItems.length - 1) return;
            openLightboxAt(currentLightboxIndex + 1);
        }

        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('open')) return;
            if (e.key === 'ArrowLeft') gotoPrev();
            if (e.key === 'ArrowRight') gotoNext();
        });

        // After image generation completes, refresh gallery head
        const _displayImageOriginal = displayImage;
        displayImage = function(imagePath) {
            _displayImageOriginal(imagePath);
            goToPage(1);
        };

        // Confirm modal for deletion
        function ensureConfirmModal() {
            let ov = document.getElementById('confirm-overlay');
            if (ov) return ov;
            ov = document.createElement('div');
            ov.className = 'confirm-overlay';
            ov.id = 'confirm-overlay';
            ov.innerHTML = `
                <div class="confirm-card">
                    <h3 class="confirm-title"><i class="fas fa-trash"></i> ì´ë¯¸ì§€ ì‚­ì œ</h3>
                    <p class="confirm-text">ì´ ì´ë¯¸ì§€ë¥¼ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í• ê¹Œìš”? (ë‚˜ì¤‘ì— ë³µêµ¬ ê°€ëŠ¥)</p>
                    <div class="confirm-actions">
                        <button class="btn-ghost" id="confirm-cancel">ì·¨ì†Œ</button>
                        <button class="btn-danger" id="confirm-ok">ì‚­ì œ</button>
                    </div>
                </div>`;
            document.body.appendChild(ov);
            ov.addEventListener('click', (e) => { if (e.target === ov) closeConfirm(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && ov.classList.contains('open')) closeConfirm(); });
            return ov;
        }

        let pendingDeleteId = null;
        function openDeleteConfirm(imageId) {
            pendingDeleteId = imageId;
            const ov = ensureConfirmModal();
            ov.classList.add('open');
            ov.setAttribute('aria-hidden', 'false');
            const cancelBtn = document.getElementById('confirm-cancel');
            const okBtn = document.getElementById('confirm-ok');
            cancelBtn.onclick = closeConfirm;
            okBtn.onclick = doDelete;
        }
        function closeConfirm() {
            const ov = document.getElementById('confirm-overlay');
            if (ov) { ov.classList.remove('open'); ov.setAttribute('aria-hidden', 'true'); }
            pendingDeleteId = null;
        }
        async function doDelete() {
            if (!pendingDeleteId) return;
            try {
                const res = await fetch(`/api/v1/images/${pendingDeleteId}/delete`, { method: 'POST' });
                if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                closeConfirm();
                // reload current page
                fetchGallery(true);
            } catch (e) {
                console.error(e);
                closeConfirm();
            }
        }

        // --- Lightbox Logic ---
        const lightbox = document.getElementById('image-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxCloseBtn = document.getElementById('lightbox-close');

        function openLightbox(src, alt = '') {
            lightboxImage.src = src;
            lightboxImage.alt = alt || 'í™•ëŒ€ëœ ì´ë¯¸ì§€';
            lightbox.classList.add('open');
            lightbox.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            lightbox.classList.remove('open');
            lightbox.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }

        ui.resultImage.addEventListener('click', () => {
            if (!ui.resultImage.src) return;
            openLightbox(ui.resultImage.src, ui.resultImage.alt);
        });

        lightboxCloseBtn.addEventListener('click', closeLightbox);

        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && lightbox.classList.contains('open')) {
                closeLightbox();
            }
        });

        async function handleCancelClick() {
            try {
                const response = await fetch('/api/v1/cancel', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Cancel failed');
                showStatus(result.message, 'info');
            } catch (error) {
                showStatus(`âŒ ì·¨ì†Œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        }
        
        document.querySelectorAll('textarea.form-input:not([readonly])').forEach(t => {
            t.addEventListener('input', () => autoResizeTextarea(t));
            autoResizeTextarea(t);
        });

        loadWorkflows();
        // ì´ˆê¸° ì§„ì… ì‹œ ê°¤ëŸ¬ë¦¬ ì¦‰ì‹œ ë¡œë“œ
        fetchGallery(true);
    });
    </script>
    <script src="/static/js/app_config.js"></script>
    
    <!-- Lightbox (ì´ë¯¸ì§€ í™•ëŒ€ ë³´ê¸°) -->
    <div class="lightbox-overlay" id="image-lightbox" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="lightbox-content" role="document">
            <button class="lightbox-close" id="lightbox-close" type="button" aria-label="ë‹«ê¸°">
                <i class="fas fa-times"></i>
            </button>
            <img id="lightbox-image" alt="í™•ëŒ€ëœ ì´ë¯¸ì§€" />
        </div>
    </div>
    <script src="/static/js/prompt_translate.js"></script>
</body>
</html>