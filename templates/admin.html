<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ComfyUI FastAPI</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/favicon/favicon-32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/static/favicon/favicon-16.png" sizes="16x16">
    <link rel="apple-touch-icon" href="/static/favicon/apple-touch-icon.png" sizes="180x180">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/styles.css?v=20250918_01" rel="stylesheet">
    <style>
        .admin-layout { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
        .admin-grid { display: grid; grid-template-columns: 280px 1fr; gap: 16px; }
        .admin-card { background: var(--bg-card); border: 1px solid var(--bg-surface); border-radius: var(--radius-xl); padding: 16px; color: var(--text-primary); }
        .admin-users { max-height: 70vh; overflow: auto; }
        .admin-user { padding: 8px 10px; border-radius: 8px; cursor: pointer; display:flex; align-items:center; color: var(--text-primary); }
        .admin-user:hover { background: var(--bg-hover); }
        .admin-user.active { background: var(--bg-tertiary); border: 1px solid var(--primary-500); }
        .admin-user::before { content: "\f007"; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-right: 8px; color: var(--text-muted); }
        .admin-user { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .admin-toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .admin-gallery { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
        @media (max-width: 1280px){ .admin-gallery{ grid-template-columns: repeat(6,1fr);} }
        @media (max-width: 1024px){ .admin-gallery{ grid-template-columns: repeat(5,1fr);} }
        @media (max-width: 768px){ .admin-gallery{ grid-template-columns: repeat(4,1fr);} }
        @media (max-width: 480px){ .admin-gallery{ grid-template-columns: repeat(3,1fr);} }
        .admin-thumb { position: relative; aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; }
        .admin-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .admin-actions { display: flex; gap: 6px; margin-top: 4px; }
        .btn { padding: 6px 10px; border: 1px solid var(--bg-surface); background: var(--bg-card); color: var(--text-primary); border-radius: 8px; cursor: pointer; }
        .btn:hover { background: var(--bg-tertiary); border-color: var(--bg-hover); }
        .btn.danger { border-color: #ef4444; color: #ef4444; }
        .btn.success { border-color: #10b981; color: #10b981; }
        .pagination { display:flex; gap:8px; justify-content:center; margin-top:12px; }
        .status-badge { position:absolute; top:8px; left:8px; padding: 3px 10px; border-radius: 9999px; font-size: 12px; font-weight: 700; color: #fff; box-shadow: var(--shadow-lg); letter-spacing: .2px; backdrop-filter: saturate(120%) blur(2px); }
        .badge-active { background: rgba(16, 185, 129, .9); border: 1px solid rgba(16, 185, 129, .3); }
        .badge-trash { background: rgba(239, 68, 68, .9); border: 1px solid rgba(239, 68, 68, .3); }
        .jobs-card { margin-top: 16px; }
        .jobs-table { width: 100%; border-collapse: collapse; font-size: 14px; color: var(--text-primary); }
        .jobs-table th, .jobs-table td { border-bottom: 1px solid var(--bg-surface); padding: 8px; text-align: left; }
        .jobs-table th { color: var(--text-secondary); background: var(--bg-tertiary); }
        .jobs-status { font-weight: 600; }
        .jobs-meta { font-size: 12px; color: var(--text-muted); }

        /* Tab buttons (Images / Jobs) */
        .tab-btn { padding: 8px 12px; border: 1px solid var(--bg-surface); border-radius: 9999px; background: var(--bg-card); color: var(--text-primary); cursor: pointer; }
        .tab-btn.active { background: var(--bg-tertiary); border-color: var(--lc-primary); color: var(--lc-primary); }

        /* Inputs/selects in dark surfaces */
        .admin-card input,
        .admin-card select { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--bg-surface); border-radius: 8px; padding: 6px 8px; }
        .admin-card input::placeholder { color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="admin-layout">
        <h1 style="margin-bottom:12px;">관리자 페이지</h1>
        <div id="health-banner" class="admin-card" style="margin-bottom:12px; display:flex; align-items:center; gap:12px;">
            <strong>상태</strong>
            <span id="hb-comfy" style="padding:2px 8px; border-radius:9999px; font-size:12px;">ComfyUI: -</span>
            <span id="hb-db" style="padding:2px 8px; border-radius:9999px; font-size:12px;">DB: -</span>
            <span id="hb-disk" style="padding:2px 8px; border-radius:9999px; font-size:12px;">Disk: -</span>
            <span id="hb-llm" style="padding:2px 8px; border-radius:9999px; font-size:12px;">LLM: -</span>
            <div style="flex:1"></div>
            <button class="btn" id="hb-refresh">새로고침</button>
        </div>
        <div class="admin-tabs" style="display:flex; gap:8px; margin-bottom:12px;">
            <button class="tab-btn active" id="tab-images" type="button">이미지</button>
            <button class="tab-btn" id="tab-jobs" type="button">작업 히스토리</button>
        </div>
        <div class="admin-grid" id="images-panel">
            <div class="admin-card admin-users">
                <h3 style="margin-top:0;">사용자 목록</h3>
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <input type="text" id="user-search" placeholder="이름 검색" style="flex:1;" />
                    <button class="btn" id="user-search-btn">검색</button>
                </div>
                <div id="user-list"></div>
                <div class="pagination" id="user-pagination" style="margin-top:8px;"></div>
            </div>
            <div class="admin-card">
                <div class="admin-toolbar">
                    <div>
                        <strong id="current-user-label">사용자 선택 안 됨</strong>
                    </div>
                    <div>
                        <select id="filter-select">
                            <option value="all">전체</option>
                            <option value="active">활성</option>
                            <option value="trash">휴지통</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <label>From <input type="date" id="from-date"></label>
                    <label>To <input type="date" id="to-date"></label>
                    <button class="btn" id="apply-date">적용</button>
                    <div style="flex:1"></div>
                    <label>페이지 크기
                        <select id="page-size" style="margin-left:6px;">
                            <option value="24">24</option>
                            <option value="48">48</option>
                            <option value="96">96</option>
                        </select>
                    </label>
                    <button class="btn danger" id="purge-trash">휴지통 비우기</button>
                </div>
                <div class="admin-gallery" id="admin-gallery"></div>
                <div class="admin-pagination" id="admin-pagination"></div>
            </div>
        </div>
        <div class="admin-card jobs-card" id="jobs-card" style="display:none;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <h3 style="margin:0;">작업 모니터링</h3>
                <div style="display:flex; align-items:center; gap:8px;">
                    <button class="btn" id="refresh-jobs">새로고침</button>
                    <label>스위프 대상(최근)
                        <input type="number" id="sweep-limit" value="200" min="1" max="5000" style="width:90px; margin-left:6px;" />
                    </label>
                    <button class="btn" id="run-sweep">스위프</button>
                </div>
            </div>
            <table class="jobs-table" id="jobs-table">
                <thead>
                    <tr>
                        <th>시간</th>
                        <th>job_id</th>
                        <th>사용자</th>
                        <th>유형</th>
                        <th>상태</th>
                        <th>ETA</th>
                        <th>진행률</th>
                        <th>결과</th>
                        <th>제어</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="jobs-meta" id="jobs-meta"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const userList = document.getElementById('user-list');
        const gallery = document.getElementById('admin-gallery');
        const pager = document.getElementById('admin-pagination');
        const currentUserLabel = document.getElementById('current-user-label');
        const filterSelect = document.getElementById('filter-select');
        const userPagination = document.getElementById('user-pagination');
        const imagesPanel = document.getElementById('images-panel');
        const jobsPanel = document.getElementById('jobs-card');
        const tabImages = document.getElementById('tab-images');
        const tabJobs = document.getElementById('tab-jobs');

        let currentUser = null;
        let userPage = 1;
        let userSize = 50;
        let userQuery = '';
        let page = 1;
        let pageSize = 24;
        let include = 'all';
        let fromDate = '';
        let toDate = '';

        const hb = {
            wrap: document.getElementById('health-banner'),
            comfy: document.getElementById('hb-comfy'),
            db: document.getElementById('hb-db'),
            disk: document.getElementById('hb-disk'),
            llm: document.getElementById('hb-llm'),
            refresh: document.getElementById('hb-refresh')
        };
        function pill(el, ok, label, reason){
            el.textContent = label + (reason ? ` (${reason})` : '');
            el.style.background = ok ? 'rgba(16,185,129,.12)' : 'rgba(239,68,68,.12)';
            el.style.border = ok ? '1px solid rgba(16,185,129,.35)' : '1px solid rgba(239,68,68,.35)';
            el.style.color = ok ? '#065f46' : '#991b1b';
        }
        async function loadHealth(){
            try {
                const res = await fetch('/healthz', { cache: 'no-store' });
                const data = await res.json();
                const c = data.components || {};
                pill(hb.comfy, !!c?.comfyui?.ok, 'ComfyUI: ' + (c?.comfyui?.ok ? 'OK' : 'FAIL'), c?.comfyui?.reason);
                pill(hb.db, !!c?.db?.ok, 'DB: ' + (c?.db?.ok ? 'OK' : 'FAIL'), c?.db?.reason);
                pill(hb.disk, !!c?.disk?.ok, 'Disk: ' + (c?.disk?.ok ? 'OK' : 'FAIL'), c?.disk?.reason);
                pill(hb.llm, !!c?.llm?.ok, 'LLM: ' + (c?.llm?.ok ? 'OK' : 'FAIL'), c?.llm?.reason);
            } catch (e) {
                pill(hb.comfy, false, 'ComfyUI: FAIL', 'fetch error');
                pill(hb.db, false, 'DB: FAIL', 'fetch error');
                pill(hb.disk, false, 'Disk: FAIL', 'fetch error');
                pill(hb.llm, false, 'LLM: FAIL', 'fetch error');
            }
        }
        hb.refresh.addEventListener('click', loadHealth);
        loadHealth();

        async function loadUsers(){
            const params = new URLSearchParams({ page: String(userPage), size: String(userSize) });
            if (userQuery) params.set('q', userQuery);
            const res = await fetch(`/api/v1/admin/users?${params.toString()}`);
            const data = await res.json();
            userList.innerHTML = '';
            data.users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'admin-user';
                div.title = u;
                div.textContent = u;
                div.addEventListener('click', () => selectUser(u, div));
                userList.appendChild(div);
            });
            renderUserPager(data.page, data.total_pages);
        }

        function renderUserPager(page, totalPages){
            userPagination.innerHTML = '';
            const left = document.createElement('div'); left.className = 'admin-pagination-left';
            const center = document.createElement('div'); center.className = 'admin-pagination-pages';
            const right = document.createElement('div'); right.className = 'admin-pagination-right';

            const makeBtn = (label, disabled, onClick) => {
                const b = document.createElement('button');
                b.className = 'adm-page-btn';
                b.textContent = label;
                b.disabled = disabled;
                if (onClick) b.addEventListener('click', onClick);
                return b;
            };
            const makeIconBtn = (iconClass, disabled, onClick, aria) => {
                const b = document.createElement('button');
                b.className = 'adm-page-btn--icon';
                b.disabled = disabled;
                b.setAttribute('type','button');
                b.setAttribute('aria-label', aria || '');
                const i = document.createElement('i'); i.className = iconClass; b.appendChild(i);
                if (onClick) b.addEventListener('click', onClick);
                return b;
            };

            left.appendChild(makeIconBtn('fas fa-angles-left', page===1, ()=>{userPage=1;loadUsers();}, '처음'));
            left.appendChild(makeIconBtn('fas fa-angle-left', page===1, ()=>{userPage=Math.max(1,page-1);loadUsers();}, '이전'));
            // No numeric pages for user list (kept simple)
            right.appendChild(makeIconBtn('fas fa-angle-right', page>=totalPages, ()=>{userPage=Math.min(totalPages,page+1);loadUsers();}, '다음'));
            right.appendChild(makeIconBtn('fas fa-angles-right', page>=totalPages, ()=>{userPage=totalPages;loadUsers();}, '마지막'));

            userPagination.appendChild(left);
            userPagination.appendChild(center);
            userPagination.appendChild(right);
        }

        document.getElementById('user-search-btn').addEventListener('click', () => {
            userQuery = (document.getElementById('user-search').value || '').trim();
            userPage = 1;
            loadUsers();
        });
        document.getElementById('user-search').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                userQuery = (document.getElementById('user-search').value || '').trim();
                userPage = 1;
                loadUsers();
            }
        });

        function selectUser(u, el){
            currentUser = u;
            page = 1;
            currentUserLabel.textContent = `선택된 사용자: ${u}`;
            document.querySelectorAll('.admin-user').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            loadImages();
        }

        async function loadImages(){
            if (!currentUser) { gallery.innerHTML = ''; pager.innerHTML=''; return; }
            const params = new URLSearchParams({ user_id: currentUser, page: String(page), size: String(pageSize), include });
            if (fromDate) params.set('from_date', fromDate);
            if (toDate) params.set('to_date', toDate);
            const res = await fetch(`/api/v1/admin/images?${params.toString()}`);
            const data = await res.json();
            renderImages(data.items);
            renderPager(data.page, data.total_pages);
        }

        function renderImages(items){
            gallery.innerHTML = '';
            items.forEach(it => {
                const wrap = document.createElement('div');
                const thumb = document.createElement('div');
                thumb.className = 'admin-thumb';
                const img = document.createElement('img');
                img.src = it.thumb_url || it.url;
                img.alt = it.id;
                thumb.appendChild(img);
                // status badge
                const badge = document.createElement('span');
                const isActive = (it.status === 'active');
                badge.className = 'status-badge ' + (isActive ? 'badge-active' : 'badge-trash');
                badge.textContent = isActive ? '활성' : '휴지통';
                thumb.appendChild(badge);
                const actions = document.createElement('div');
                actions.className = 'admin-actions';
                if (isActive) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn danger';
                    delBtn.textContent = '휴지통으로';
                    delBtn.addEventListener('click', () => updateImage(it.id, 'delete'));
                    actions.appendChild(delBtn);
                } else {
                    const resBtn = document.createElement('button');
                    resBtn.className = 'btn success';
                    resBtn.textContent = '복구';
                    resBtn.addEventListener('click', () => updateImage(it.id, 'restore'));
                    actions.appendChild(resBtn);
                }
                wrap.appendChild(thumb);
                wrap.appendChild(actions);
                gallery.appendChild(wrap);
            });
        }

        function renderPager(p, total){
            pager.innerHTML = '';
            const left = document.createElement('div'); left.className = 'admin-pagination-left';
            const center = document.createElement('div'); center.className = 'admin-pagination-pages';
            const right = document.createElement('div'); right.className = 'admin-pagination-right';

            const makeBtn = (label, disabled, onClick) => {
                const b = document.createElement('button');
                b.className = 'adm-page-btn';
                b.textContent = label;
                b.disabled = disabled;
                if (onClick) b.addEventListener('click', onClick);
                return b;
            };
            const makeIconBtn = (iconClass, disabled, onClick, aria) => {
                const b = document.createElement('button');
                b.className = 'adm-page-btn--icon';
                b.disabled = disabled;
                b.setAttribute('type','button');
                b.setAttribute('aria-label', aria || '');
                const i = document.createElement('i'); i.className = iconClass; b.appendChild(i);
                if (onClick) b.addEventListener('click', onClick);
                return b;
            };

            left.appendChild(makeIconBtn('fas fa-angles-left', p===1, ()=>{page=1;loadImages();}, '처음'));
            left.appendChild(makeIconBtn('fas fa-angle-left', p===1, ()=>{page=Math.max(1,p-1);loadImages();}, '이전'));

            const windowSize = 5;
            const start = Math.max(1, p - Math.floor(windowSize/2));
            const end = Math.min(total, start + windowSize - 1);
            for (let n = start; n <= end; n++) {
                const num = makeBtn(String(n), n === p, () => { page = n; loadImages(); });
                if (n === p) num.classList.add('active');
                center.appendChild(num);
            }

            right.appendChild(makeIconBtn('fas fa-angle-right', p===total, ()=>{page=Math.min(total,p+1);loadImages();}, '다음'));
            right.appendChild(makeIconBtn('fas fa-angles-right', p===total, ()=>{page=total;loadImages();}, '마지막'));

            pager.appendChild(left);
            pager.appendChild(center);
            pager.appendChild(right);
        }

        async function updateImage(id, action){
            if (!currentUser) return;
            const url = action === 'delete' ? `/api/v1/admin/images/${id}/delete` : `/api/v1/admin/images/${id}/restore`;
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ user_id: currentUser }) });
            if (res.ok){ loadImages(); }
        }

        filterSelect.addEventListener('change', () => { include = filterSelect.value; page = 1; loadImages(); });

        document.getElementById('apply-date').addEventListener('click', () => {
            fromDate = document.getElementById('from-date').value;
            toDate = document.getElementById('to-date').value;
            page = 1;
            loadImages();
        });
        document.getElementById('page-size').addEventListener('change', (e) => {
            const v = parseInt(e.target.value, 10);
            pageSize = Number.isFinite(v) ? v : 24;
            page = 1;
            loadImages();
        });

        document.getElementById('purge-trash').addEventListener('click', async () => {
            if (!currentUser) return;
            if (!confirm('휴지통을 비우시겠습니까? 복구할 수 없습니다.')) return;
            const res = await fetch('/api/v1/admin/purge-trash', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: currentUser }) });
            if (res.ok) { loadImages(); }
        });

        function activateTab(btn){
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        function showImagesTab(){
            imagesPanel.style.display = '';
            jobsPanel.style.display = 'none';
            activateTab(tabImages);
            loadUsers();
        }
        function showJobsTab(){
            imagesPanel.style.display = 'none';
            jobsPanel.style.display = '';
            activateTab(tabJobs);
            loadJobs();
            loadMetrics();
        }
        tabImages.addEventListener('click', showImagesTab);
        tabJobs.addEventListener('click', showJobsTab);
        showImagesTab();

        // ---- Jobs monitor ----
        const missingArtifacts = new Set();
        const jobsTableBody = document.querySelector('#jobs-table tbody');
        async function loadJobs(){
            try {
                const res = await fetch('/api/v1/admin/jobs?limit=100');
                const data = await res.json();
                renderJobs(Array.isArray(data.jobs) ? data.jobs : []);
            } catch (e) {
                console.error(e);
            }
        }
        async function loadMetrics(){
            try {
                const res = await fetch('/api/v1/admin/jobs/metrics?limit=50');
                const data = await res.json();
                renderJobsMeta(data);
                return data;
            } catch (e) { return {}; }
        }
        function renderJobsMeta(m){
            const el = document.getElementById('jobs-meta');
            if (!el) return;
            const overall = (typeof m.overall_avg_sec === 'number') ? `${Math.round(m.overall_avg_sec)}s` : '-';
            el.textContent = `최근 평균 처리시간(전체): ${overall}`;
        }
        function renderJobs(jobs){
            jobsTableBody.innerHTML = '';
            let metricsCache = null;
            const ensureMetrics = async () => { if (!metricsCache) metricsCache = await loadMetrics(); return metricsCache; };
            jobs.forEach(async j => {
                const tr = document.createElement('tr');
                const dt = j.created_at ? new Date(j.created_at * 1000) : null;
                const dtText = dt ? dt.toLocaleString() : '';
                const metrics = await ensureMetrics();
                const overall = (typeof metrics.overall_avg_sec === 'number') ? metrics.overall_avg_sec : null;
                const perWf = (metrics.per_workflow_avg_sec && j?.result?.workflow_id) ? metrics.per_workflow_avg_sec[j.result.workflow_id] : null;
                const avg = (typeof perWf === 'number') ? perWf : overall;
                let etaStr = '-';
                if (avg && j.status === 'queued') {
                    etaStr = `~${Math.max(1, Math.round(avg))}s`;
                } else if (avg && j.status === 'running' && j.started_at) {
                    const elapsed = (Date.now()/1000 - j.started_at);
                    const remain = Math.max(0, avg - elapsed);
                    etaStr = `~${Math.max(0, Math.round(remain))}s`;
                }
                const imgUrl = j?.result?.image_path;
                const avail = !!j?.artifact_available;
                const resultCell = imgUrl ? (avail ? `<a href="${imgUrl}" data-result-link="true">결과보기</a>` : '삭제됨') : '';
                tr.innerHTML = `
                    <td>${dtText}</td>
                    <td style="font-family:monospace;">${j.id}</td>
                    <td>${j.owner_id}</td>
                    <td>${j.type}</td>
                    <td class="jobs-status">${j.status}</td>
                    <td>${etaStr}</td>
                    <td>${Math.round(j.progress || 0)}%</td>
                    <td>${resultCell}</td>
                    <td>${j.status === 'queued' || j.status === 'running' ? `<button class="btn danger" data-cancel="${j.id}">취소</button>` : ''}</td>
                `;
                jobsTableBody.appendChild(tr);
            });
            // Graceful handling for missing artifacts: bind once globally to avoid duplicate alerts on refresh
            if (!window.__adminJobsLinkBound) {
                jobsTableBody.addEventListener('click', async (e) => {
                    const a = e.target.closest('a[data-result-link]');
                    if (!a) return;
                    e.preventDefault();
                    const url = a.getAttribute('href');
                    try {
                        const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
                        if (res.ok) {
                            window.open(url, '_blank');
                        } else {
                            try { missingArtifacts.add(url); } catch (_) {}
                            a.replaceWith(document.createTextNode('삭제됨'));
                            if (!a.__alertedOnce) { alert('파일이 삭제되었거나 만료되었습니다. (히스토리는 메타만 유지됨)'); a.__alertedOnce = true; }
                        }
                    } catch (err) {
                        try { missingArtifacts.add(url); } catch (_) {}
                        a.replaceWith(document.createTextNode('삭제됨'));
                        if (!a.__alertedOnce) { alert('파일이 삭제되었거나 만료되었습니다. (히스토리는 메타만 유지됨)'); a.__alertedOnce = true; }
                    }
                });
                window.__adminJobsLinkBound = true;
            }
            jobsTableBody.querySelectorAll('button[data-cancel]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-cancel');
                    if (!id) return;
                    try {
                        await fetch(`/api/v1/jobs/${id}/cancel`, { method: 'POST' });
                        loadJobs();
                    } catch (e) {}
                });
            });
        }
        document.getElementById('refresh-jobs').addEventListener('click', () => { loadJobs(); loadMetrics(); });
        document.getElementById('run-sweep').addEventListener('click', async () => {
            const n = parseInt(document.getElementById('sweep-limit').value, 10);
            const limit = Number.isFinite(n) ? n : 200;
            try {
                const res = await fetch(`/api/v1/admin/jobs/sweep?limit=${encodeURIComponent(limit)}`, { method: 'POST' });
                const data = await res.json();
                if (res.ok) {
                    alert(`스위프 완료: ${data.updated}건 동기화`);
                    loadJobs();
                } else {
                    alert(data.detail || '스위프 실패');
                }
            } catch (e) {
                alert('스위프 중 오류 발생');
            }
        });
    });
    </script>
</body>
</html>

