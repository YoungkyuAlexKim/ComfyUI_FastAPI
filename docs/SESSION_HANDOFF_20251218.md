# 작업 현황서 + 다음 세션 요청서(핸드오프 문서) — `ComfyUI_FastAPI` (2025-12-18)

아래 문서는 **새 대화창에서 다른 동료 AI가 바로 이어서 코딩/운영 대응**을 할 수 있도록, 프로젝트 목적/구조/이번 세션 변경점/현재 이슈/다음 작업 후보를 최대한 구체적으로 정리한 것입니다.  
(대화는 공손한 한국어 + 비개발자도 이해 가능한 설명을 기본으로 합니다 [[memory:12236647]].)

---

## 1) 이 프로젝트는 무엇인가
- **목적**: ComfyUI를 이미지 생성 엔진으로 쓰고, 그 앞에 **FastAPI + 웹 UI(HTML/JS/CSS)**를 붙여 여러 사용자가 동시에 이미지 생성/대기/취소/갤러리/쇼케이스(공유 피드)를 사용하도록 하는 서비스.
- **사용자 구분**: 로그인 대신 브라우저 쿠키 `anon_id`로 사용자 구분.
- **운영 데이터**:
  - 이미지/썸네일/메타는 DB가 아니라 **파일 기반 저장(사이드카 JSON + thumb)**.
  - Job/피드 메타는 `db/app_data.db`(SQLite).
- **배포 전제(매우 중요)**: 개발PC에서 작업 후 **서버PC에 코드만 복사-붙여넣기 배포**. 서버 운영 데이터는 덮어쓰면 안 됨 [[memory:12313212]].

---

## 2) 배포/복사-붙여넣기 운영 규칙(서버 PC)
- **절대 덮어쓰면 안 되는 것** [[memory:12313212]]:
  - `outputs/`
  - `db/` (특히 `db/app_data.db`)
  - `venv/`
  - `logs/` (가능하면 유지)
- **추가로 주의할 것(이번 세션에서 확인됨)**:
  - **`.env`**: 서버 전용 설정(비번/경로/제한)이 있으니 서버의 `.env`는 보통 유지(덮어쓰기 금지 권장).
  - **`models/`**: 프롬프트 번역 모델(`models/gemma-3-4b-it-Q6_K.gguf`)이 필요한 구성이라면 서버에 존재해야 함(없으면 번역/헬스 체크에서 영향 가능).

---

## 3) 이번 세션에서 완료한 작업(문서 12.1~12.5 + 안정성 보완)
### 3.1 쇼케이스(Feed) UX 폴리싱 5종 “순차 적용” 완료
- **12.1 피드 빈 상태 UX 추가**
  - 게시물 0개일 때 안내 카드 + `/create` 이동 CTA 표시
  - 파일:
    - `templates/feed.html` (`#feed-empty` 추가)
    - `static/css/feed.css` (빈 상태 카드 스타일)
    - `static/js/feed.js` (total=0일 때 빈 상태 토글)

- **12.2 네트워크 실패/느림 안내 개선**
  - `alert()` 대신 **토스트 안내(UIToast)** 도입
  - 피드 로딩/상세 모달/리액션/삭제 실패 시 토스트로 안내
  - fetch에 **timeout(AbortController)** 추가(너무 오래 걸리면 친절한 메시지)
  - 파일:
    - `static/js/ui_toast.js` (신규)
    - `static/css/components.css` (토스트 스타일 추가)
    - `templates/base.html` (전역으로 `ui_toast.js` 로드)
    - `static/js/feed.js` (alert 제거, notifyError/timeout 적용)

- **12.3 정렬 안정성 개선(“반응 많은 순” 흔들림 제거)**
  - `most_reactions` 동점 시 기존 `RANDOM()` 제거 → **published_at, post_id로 안정 정렬**
  - 파일:
    - `app/feed_store.py` (`list_posts()` 정렬 SQL 변경)

- **12.4 성능/체감 개선**
  - 썸네일 `loading="lazy"`, `decoding="async"`
  - 정렬 변경/새로고침 시 스켈레톤 카드(로딩 느낌 개선)
  - “더 보기” 버튼 로딩 표시(버튼 disable + 스피너)
  - 파일:
    - `static/js/feed.js`
    - `static/css/feed.css`

- **12.5 상세 모달 접근성/조작감 보강**
  - 모달/삭제 확인 모달에 **포커스 트랩(Tab 순환)**, ESC 닫기 유지, 닫을 때 **포커스 복원**
  - 모달 닫기 버튼 터치 영역 확대
  - 파일:
    - `static/js/feed.js`
    - `static/css/feed.css`

### 3.2 “남아있던 alert 팝업” 토스트로 통일(쇼케이스 외 영역)
- 컨트롤 캔버스/프롬프트 번역에서 `alert()` → 토스트 우선 사용
- 파일:
  - `static/js/control_canvas.js`
  - `static/js/prompt_translate.js`

### 3.3 베타 로그인/쿠키 관련 안정성 보완(모바일 이슈 대응)
- **문제**: `COOKIE_SECURE=true`인데 `http://...`로 접속 시(특히 모바일) Secure 쿠키가 저장/전송되지 않아 **로그인 루프(비번 넣어도 계속 튕김)** 발생 가능.
- **대응(코드 보완)**:
  - HTTP 접속이면 Secure 쿠키를 강제로 끄도록 처리(HTTPS일 때만 Secure 유지).
  - `/beta-login` 페이지에 “쿠키/앱내브라우저/시크릿창” 안내문 추가 + 캐시 금지 헤더(`Cache-Control: no-store`).
- 파일:
  - `app/main.py` (`/beta-login` GET/POST)
  - `app/auth/user_management.py` (`anon_id` 쿠키 secure 처리도 동일한 원칙 적용)

### 3.4 “무한 로딩(하얀 화면)” 방지 목적: 외부 CDN CSS 비차단 로딩
- 일부 환경에서 외부 CDN(FontAwesome/Google Fonts)이 막힐 때 **렌더링 지연/공백 느낌**을 줄이기 위해, 외부 CSS를 `media="print"` + `onload` 방식으로 비차단 로딩.
- 파일:
  - `templates/base.html`

---

## 4) 현재 운영/테스트 상황에서 자주 나오는 이슈 패턴(원인/대응)
- **모바일/특정 사용자만 접속 불가**
  - **IP allowlist(인프라 차단)** 가능성이 큼: 회사/집 Wi‑Fi는 되는데 휴대폰 데이터는 안 됨 → 거의 확실히 방화벽/허용 IP 이슈.
  - 확인: `http://공인IP:8000/healthz` 접속 가능 여부.

- **베타 비번 넣어도 접속 안 됨**
  - `COOKIE_SECURE=true` + HTTP 접속이면 Secure 쿠키 이슈 가능.
  - 운영 권장: HTTP로 운영이면 **`.env`에서 `COOKIE_SECURE=false`**.

- **“/beta-login 빼면 우회되나?”**
  - 전역 베타 게이트 미들웨어가 있어 **우회 불가**.
  - 단, 비번 성공 후 쿠키가 남아있는 브라우저는 주소만 입력해도 들어가지는 것처럼 보일 수 있음.

---

## 5) 큐(대기열) UI 현황
- 생성 페이지(`/create`)에서 대기 상태면:
  - **“대기 n번째”** 표시됨
  - `/api/v1/jobs/metrics` 기반으로 **“예상 시작 ~xx초 후”**도 표시됨(간단 ETA)
- 위치:
  - `templates/partials/input_panel.html`의 `#queue-info`가 진행률 바 영역 안에 있고, 대기 시 표시됨.
- 구현:
  - `templates/index.html`에서 `position`을 받아 문구 표기 + 2초마다 `/api/v1/jobs/{job_id}` 폴링으로 업데이트.

---

## 6) “스트리밍 미리보기(생성 중 썸네일)” 피드백 논의 결론(작업 중단/미구현)
- 사용자 피드백: “입력값/시드 저장 후 저해상도·노이즈 많은 이미지라도 빨리 보고 싶다. 마음에 들면 고해상도로 뽑고 싶다.”
- 논의 결론:
  - 현재 병목이 **모델 준비(약 8초) + 생성(총 15~20초)** 성격이라, 단순 “저해상도/저스텝”이 체감 시간 단축에 큰 도움은 제한적일 수 있음.
  - 진짜 해결은 “시간 단축”보다 **단계 안내(모델 준비/생성/마무리)** 같은 UX가 더 현실적.
  - “초안→최종”을 하려면 **img2img로 초안을 입력으로 이어가기(denoise 낮게)** 같은 설계가 필요(단순 저해상도 1회로는 ‘다른 이미지’ 문제가 큼).
- **중요**: 사용자 요청으로 “이후에는 작업은 다음 세션”으로 결정했고, 이번 세션에서는 **실제 미리보기 스트리밍 구현은 하지 않음**.

---

## 7) 다음 세션에서 할 일(요청서 / 우선순위)
### A. 베타 운영 중 들어오는 버그/피드백 대응(핫픽스)
- **현상 기반**으로 빠르게 원인 분류:
  - IP 차단/allowlist 여부(healthz)
  - 쿠키/브라우저(특히 모바일, 앱내브라우저 여부)
  - CDN 차단(폰트/아이콘) 여부
  - 큐/타임아웃(429/timeout) 여부

### B. “기다림이 길다(15초도 길다)” UX 대응(코드 변경은 다음 세션에서 진행)
- 목표: 시간 단축보다 **체감 개선**
- 후보:
  - 생성 상태 문구를 “요청 처리/모델 준비/생성/마무리”처럼 단계화
  - 대기열/ETA 문구를 더 눈에 띄게(사용자가 실제로 인지하도록)

### C. “미리보기(초안) → 최종(고해상도)” 기능은 큰 기능으로 별도 설계 필요
- 가능성은 있으나, Qwen 무거움/준비시간 특성 때문에 단순 저해상도는 기대 대비 효용이 낮을 수 있음.
- 구현 시:
  - 워크플로우 2개(초안/최종) 또는 파라미터 스위치
  - 초안 결과를 최종의 img2img 입력으로 이어서 “다른 이미지” 문제 완화
  - UI는 “빠른 미리보기 / 최종 출력” 두 버튼 또는 모드로 제공

---

## 8) 이번 세션 변경 파일 목록(빠른 확인용)
- **Feed/쇼케이스**
  - `templates/feed.html`
  - `static/js/feed.js`
  - `static/css/feed.css`
  - `app/feed_store.py`
- **토스트(공통)**
  - `static/js/ui_toast.js` (신규)
  - `static/css/components.css`
  - `templates/base.html` (전역 로드 + CDN 비차단 로드)
- **컨트롤/번역 알림 개선**
  - `static/js/control_canvas.js`
  - `static/js/prompt_translate.js`
- **베타 로그인/쿠키 안정화**
  - `app/main.py`
  - `app/auth/user_management.py`

---

## 9) 운영자(사용자)용 초간단 체크(다음 세션에서도 그대로 사용 가능)
- **접속 문제 확인**: `http://공인IP:8000/healthz`가 열리나?
- **HTTP 운영이면**: `.env`의 `COOKIE_SECURE=false`
- **대기열 표기 확인**: `/create`에서 동시 2명 생성 → 한쪽에 “대기 n번째” 표시되는지
- **쇼케이스 기본 동작**: `/feed` 로딩 → 정렬 변경 → 리액션/삭제 확인


