# 인증/사용자 관리 로드맵 메모 (점진적 도입)

## 목표
- 간단한 세션/게스트 단계에서 시작해도, 추후 OAuth/이메일 로그인, RBAC로 자연스럽게 확장
- 이미지 스토리지 스킴과 일관된 `user_id`(UUID/ULID)로 리소스 소유권을 명확히

## 1) 초기 단계(게스트 + 최소 세션)
- 게스트 네임스페이스: outputs/users/guest/{session_id}/...
- 세션 보관: 서버 메모리/서명 쿠키(만료 짧게), CSRF 방어
- 제한: 게스트 쿼터(갯수/용량/보존기간), 이후 로그인 유도

## 2) 기본 로그인(이메일/비밀번호 또는 Magic Link)
- Password: 해시(Argon2/Bcrypt), 비밀번호 재설정 토큰(만료), 이메일 검증
- Magic Link(선호): 이메일 링크 기반 1회성 토큰 로그인
- 토큰: 세션 쿠키(HTTPOnly, Secure), 짧은 수명 + 갱신
- 사용자 프로필: { id(ULID), email, email_verified, created_at, plan, quota }

## 3) 소셜 로그인(OAuth 2.0 / OIDC)
- Google/GitHub/Apple 등 프로바이더 연결, 이메일/프로필 동기화
- 내부 `user_id`는 별도 유지, 외부 계정은 연결 테이블로 관리

## 4) 권한/역할(RBAC)
- roles: [user, pro, admin]
- 정책: 자신의 리소스만 CRUD, admin은 관리 도구 접근
- 리소스 접근은 항상 서버가 `user_id` 스코프로 필터

## 5) 보안 원칙
- 모든 민감 토큰/쿠키는 HTTPOnly/SameSite/Strict, Secure
- 프리사인 URL로 파일 접근(짧은 만료, 1회성 가능)
- Rate limit/속도 제한, 로그인 시도 제한, 2FA(추가 단계)

## 6) API/프론트 연동
- 클라이언트: 로그인 상태 감지 → `/me`로 프로필/쿼터 가져오기
- 서버: 미들웨어로 인증 검사, `request.user.id`를 통해 스코프 강제
- 이미지 API는 항상 `user_id` 스코프 기준으로 목록/조회/삭제

## 7) 마이그레이션/운영
- 게스트 → 회원 전환: 게스트 세션의 이미지 소유권을 신규 `user_id`로 이관
- 감사 로그: 로그인/삭제/복구 이벤트 로깅
- 백업/복구: 사용자 단위 내보내기/불러오기

## 8) 향후(구독/결제)
- Stripe 등 결제 연동, 플랜별 쿼터/보존기간/해상도 제한
- 청구 이벤트에 따른 역할/권한 자동 변경

(인증 도입 시 이 메모를 최신 상태로 유지합니다)
